<!-- templates/document_detail.html -->
{% extends "base.html" %}

{% block content %}
<div class="document-detail">
  <div class="detail-container">
    <div class="info-panel">
      <!-- Navigation -->
      <div class="navigation">
        <a href="{{ url_for('search_database') }}?return_to_search=true" class="button button--secondary nav-button" title="Return to Search Results">
          <span>Search</span>
        </a>
        <a href="{{ prev_id and url_for('document_detail', doc_id=prev_id, search_id=search_id) or '#' }}"
           class="button button--secondary nav-button {{ 'disabled' if not prev_id else '' }}"
           title="Previous Result"
           {% if not prev_id %}aria-disabled="true" tabindex="-1"{% endif %}>
          <span>Previous</span>
        </a>
        <a href="{{ url_for('index') }}" class="button button--secondary nav-button" title="Home">
          <span>Home</span>
        </a>
        <a href="{{ next_id and url_for('document_detail', doc_id=next_id, search_id=search_id) or '#' }}"
           class="button button--secondary nav-button {{ 'disabled' if not next_id else '' }}"
           title="Next Result"
           {% if not next_id %}aria-disabled="true" tabindex="-1"{% endif %}>
          <span>Next</span>
        </a>
      </div>

      <!-- Document Title -->
       <h1>{{ display_filename }}</h1>
      

    
      

      <div class="info-container">
        <!-- Render Summary -->
        {% if document.summary %}
          <div class="info-section">
            <h2>Summary</h2>
            <p>{{ document.summary }}</p>
          </div>
        {% endif %}

        <!-- Render OCR Text -->
        {% if document.ocr_text %}
          <div class="info-section">
            <h2>OCR Text</h2>
            <p>{{ document.ocr_text }}</p>
          </div>
        {% endif %}

        {% set biographical_narrative = none %}
        {% if document.person_synthesis and document.person_synthesis is mapping %}
          {% set biographical_narrative = document.person_synthesis.get('biographical_narrative') or document.person_synthesis.get('Biographical Narrative') %}
        {% endif %}

        {% if biographical_narrative %}
          <div class="info-section">
            <h2>Biographical Narrative</h2>
            <p>{{ biographical_narrative }}</p>
          </div>
        {% endif %}

        <!-- Render Sections -->
        {% for section in document.sections %}
          {{ render_section(section) }}
        {% endfor %}

        <!-- Render All Extracted Entities -->
        {% if document.extracted_entities %}
          <div class="info-section">
            <h2>Extracted Entities</h2>
            {% for type, entities in document.extracted_entities | groupby('type') %}
              <div class="entity-group">
                <h3>{{ type }}</h3>
                <ul>
                  {% for entity in entities %}
                    <li>{{ entity.text }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        {% if document.person_synthesis %}
          <!-- Render person synthesis with nested formatting so it matches the other structured JSON blocks -->
          <div class="info-section">
            <h2>Person Synthesis</h2>
            <div class="nested-block">
              {% if document.person_synthesis is mapping %}
                <table class="info-table nested">
                  {% for subkey, subvalue in document.person_synthesis.items() %}
                    {% if subkey != 'biographical_narrative' and subkey != 'Biographical Narrative' %}
                      <tr>
                        <th>{{ subkey.replace('_', ' ') | title }}</th>
                        <td>
                          {% if subvalue is mapping or (subvalue is iterable and not subvalue is string) %}
                            {{ render_nested_value(subvalue) }}
                          {% else %}
                            {{ subvalue }}
                          {% endif %}
                        </td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </table>
              {% else %}
                {{ render_nested_value(document.person_synthesis) }}
              {% endif %}
            </div>
          </div>
        {% endif %}


      </div>
    </div>

    <!-- Resizer Element -->
    <div class="resizer"></div>

    <!-- Image Panel -->
    <div class="image-panel">
      {% if image_exists %}
        <div id="imageContainer">
          <img id="documentImage" src="{{ url_for('serve_image', filename=image_path) }}" alt="Document Image">
        </div>
        <div class="zoom-controls">
          <button id="rotateLeft">Rotate Left</button>
          <button id="rotateRight">Rotate Right</button>
          <button id="zoomIn">Zoom In</button>
          <button id="zoomOut">Zoom Out</button>
          <button id="resetZoom">Reset</button>
        </div>
        <div class="adjustment-controls">
          <div class="control-group">
            <label for="brightnessRange">Brightness:</label>
            <input type="range" id="brightnessRange" min="0.5" max="1.5" step="0.1" value="1" title="1">
          </div>
          <div class="control-group">
            <label for="contrastRange">Contrast:</label>
            <input type="range" id="contrastRange" min="0.5" max="2" step="0.1" value="1" title="1">
          </div>
          <div class="control-group">
            <label for="saturationRange">Saturation:</label>
            <input type="range" id="saturationRange" min="0" max="3" step="0.1" value="1" title="1">
          </div>
          <div class="control-group">
            <label for="hueRange">Hue Rotation:</label>
            <input type="range" id="hueRange" min="0" max="360" step="10" value="0" title="0">
          </div>
          <div class="control-group">
            <label for="sharpenRange">Sharpen:</label>
            <input type="range" id="sharpenRange" min="0" max="5" step="0.1" value="0" title="0">
          </div>
          <div class="control-group">
            <label for="thresholdRange">Threshold:</label>
            <input type="range" id="thresholdRange" min="0" max="255" step="1" value="128" title="128">
          </div>
          <div class="buttons-group">
            <button id="grayscaleBtn">Grayscale</button>
            <button id="sepiaBtn">Sepia</button>
            <button id="invertBtn">Invert Colors</button>
            <button id="flipHorizontalBtn">Flip Horizontal</button>
            <button id="flipVerticalBtn">Flip Vertical</button>
            <button id="resetAllBtn">Reset All</button>
          </div>
        </div>
        <!-- SVG Filters -->
        <svg width="0" height="0">
          <!-- Sharpen Filter -->
          <filter id="sharpen">
            <feConvolveMatrix in="SourceGraphic" order="3" kernelMatrix="0 -1 0 -1 5 -1 0 -1 0" />
          </filter>
          <!-- Threshold Filter -->
          <filter id="threshold">
            <feComponentTransfer>
              <feFuncR type="linear" slope="1" intercept="0"/>
              <feFuncG type="linear" slope="1" intercept="0"/>
              <feFuncB type="linear" slope="1" intercept="0"/>
            </feComponentTransfer>
            <feColorMatrix type="matrix" values="
              1 0 0 0 0
              0 1 0 0 0
              0 0 1 0 0
              0 0 0 1 0" />
            <feComponentTransfer>
              <feFuncR type="discrete" tableValues="0 1"/>
              <feFuncG type="discrete" tableValues="0 1"/>
              <feFuncB type="discrete" tableValues="0 1"/>
            </feComponentTransfer>
          </filter>
        </svg>
      {% else %}
        <div class="placeholder-image">
          <p>Image not found: {{ image_path }}</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Image Manipulation Code
    let scale = 1;
    let rotation = 0;
    const ZOOM_STEP = 0.1;
    const MAX_SCALE = 3;
    const MIN_SCALE = 0.5;

    // Filter Controls
    const brightnessRange = document.getElementById('brightnessRange');
    const contrastRange = document.getElementById('contrastRange');
    const saturationRange = document.getElementById('saturationRange');
    const hueRange = document.getElementById('hueRange');
    const sharpenRange = document.getElementById('sharpenRange');
    const thresholdRange = document.getElementById('thresholdRange');

    // Buttons
    const grayscaleBtn = document.getElementById('grayscaleBtn');
    const sepiaBtn = document.getElementById('sepiaBtn');
    const invertBtn = document.getElementById('invertBtn');
    const flipHorizontalBtn = document.getElementById('flipHorizontalBtn');
    const flipVerticalBtn = document.getElementById('flipVerticalBtn');
    const resetAllBtn = document.getElementById('resetAllBtn');

    // Image Elements
    const imageContainer = document.getElementById('imageContainer');
    const documentImage = document.getElementById('documentImage');

    // SVG Filters
    const sharpenFilter = document.getElementById('sharpen');
    const thresholdFilter = document.getElementById('threshold');

    // State Variables
    let isGrayscale = false;
    let isSepia = false;
    let isInverted = false;
    let isFlippedHorizontal = false;
    let isFlippedVertical = false;

    // Transform Functions
    function setImageTransform() {
      let transforms = [];

      // Scaling
      transforms.push(`scale(${scale})`);

      // Rotation
      transforms.push(`rotate(${rotation}deg)`);

      // Flipping
      const flipX = isFlippedHorizontal ? -1 : 1;
      const flipY = isFlippedVertical ? -1 : 1;
      transforms.push(`scale(${flipX}, ${flipY})`);

      documentImage.style.transform = transforms.join(' ');
    }

    // Filter Update Function
    function updateFilters() {
      let filters = [];

      // Basic Filters
      const brightnessValue = brightnessRange.value;
      const contrastValue = contrastRange.value;
      const saturationValue = saturationRange.value;
      const hueValue = hueRange.value;
      const sharpenValue = parseFloat(sharpenRange.value);
      const thresholdValue = parseInt(thresholdRange.value, 10);

      // Update title attributes
      brightnessRange.title = brightnessValue;
      contrastRange.title = contrastValue;
      saturationRange.title = saturationValue;
      hueRange.title = hueValue;
      sharpenRange.title = sharpenValue;
      thresholdRange.title = thresholdValue;

      filters.push(`brightness(${brightnessValue})`);
      filters.push(`contrast(${contrastValue})`);
      filters.push(`saturate(${saturationValue})`);
      filters.push(`hue-rotate(${hueValue}deg)`);

      // Sharpen
      if (sharpenValue > 0) {
        const newCenter = 5 + (sharpenValue * 2);
        sharpenFilter.setAttribute('kernelMatrix', `0 -1 0 -1 ${newCenter} -1 0 -1 0`);
        filters.push('url(#sharpen)');
      } else {
        sharpenFilter.setAttribute('kernelMatrix', '0 0 0 0 1 0 0 0 0');
      }

      // Threshold
      if (thresholdValue !== 128) { // Default value
        const normalized = thresholdValue / 255;
        thresholdFilter.querySelectorAll('feFuncR, feFuncG, feFuncB').forEach(func => {
          func.setAttribute('slope', '1');
          func.setAttribute('intercept', normalized < 0.5 ? '-1' : '0');
        });
        filters.push('url(#threshold)');
      }

      // Grayscale
      if (isGrayscale) {
        filters.push('grayscale(1)');
      }

      // Sepia
      if (isSepia) {
        filters.push('sepia(1)');
      }

      // Invert
      if (isInverted) {
        filters.push('invert(1)');
      }

      documentImage.style.filter = filters.join(' ');
    }

    // Event Listeners for Sliders
    [brightnessRange, contrastRange, saturationRange, hueRange, sharpenRange, thresholdRange].forEach(slider => {
      slider.addEventListener('input', updateFilters);
    });

    // Button Event Listeners
    grayscaleBtn.addEventListener('click', () => {
      isGrayscale = !isGrayscale;
      if (isGrayscale) isSepia = false;
      updateFilters();
    });

    sepiaBtn.addEventListener('click', () => {
      isSepia = !isSepia;
      if (isSepia) isGrayscale = false;
      updateFilters();
    });

    invertBtn.addEventListener('click', () => {
      isInverted = !isInverted;
      updateFilters();
    });

    flipHorizontalBtn.addEventListener('click', () => {
      isFlippedHorizontal = !isFlippedHorizontal;
      setImageTransform();
    });

    flipVerticalBtn.addEventListener('click', () => {
      isFlippedVertical = !isFlippedVertical;
      setImageTransform();
    });

    resetAllBtn.addEventListener('click', () => {
      // Reset transforms
      scale = 1;
      rotation = 0;
      isFlippedHorizontal = false;
      isFlippedVertical = false;
      setImageTransform();

      // Reset filters
      brightnessRange.value = 1;
      contrastRange.value = 1;
      saturationRange.value = 1;
      hueRange.value = 0;
      sharpenRange.value = 0;
      thresholdRange.value = 128;
      isGrayscale = false;
      isSepia = false;
      isInverted = false;
      updateFilters();
    });

    // Zoom and Rotate Functions
    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    const resetZoomBtn = document.getElementById('resetZoom');
    const rotateLeftBtn = document.getElementById('rotateLeft');
    const rotateRightBtn = document.getElementById('rotateRight');

    function zoomIn() {
      if (scale < MAX_SCALE) {
        scale += ZOOM_STEP;
        setImageTransform();
      }
    }

    function zoomOut() {
      if (scale > MIN_SCALE) {
        scale -= ZOOM_STEP;
        setImageTransform();
      }
    }

    function resetZoom() {
      scale = 1;
      rotation = 0;
      setImageTransform();
    }

    function rotateLeft() {
      rotation -= 90;
      setImageTransform();
    }

    function rotateRight() {
      rotation += 90;
      setImageTransform();
    }

    zoomInBtn.addEventListener('click', zoomIn);
    zoomOutBtn.addEventListener('click', zoomOut);
    resetZoomBtn.addEventListener('click', resetZoom);
    rotateLeftBtn.addEventListener('click', rotateLeft);
    rotateRightBtn.addEventListener('click', rotateRight);

    // Dragging Functionality
    let isDragging = false;
    let startX, startY, scrollLeft, scrollTop;

    imageContainer.addEventListener('mousedown', (e) => {
      isDragging = true;
      imageContainer.classList.add('active');
      startX = e.pageX - imageContainer.offsetLeft;
      startY = e.pageY - imageContainer.offsetTop;
      scrollLeft = imageContainer.scrollLeft;
      scrollTop = imageContainer.scrollTop;
    });

    imageContainer.addEventListener('mouseleave', () => {
      isDragging = false;
      imageContainer.classList.remove('active');
    });

    imageContainer.addEventListener('mouseup', () => {
      isDragging = false;
      imageContainer.classList.remove('active');
    });

    imageContainer.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      e.preventDefault();
      const x = e.pageX - imageContainer.offsetLeft;
      const y = e.pageY - imageContainer.offsetTop;
      const walkX = x - startX;
      const walkY = y - startY;
      imageContainer.scrollLeft = scrollLeft - walkX;
      imageContainer.scrollTop = scrollTop - walkY;
    });

    // Initial Filter Setup
    updateFilters();

    // Resizer Code
    const resizer = document.querySelector('.resizer');
    const leftSide = resizer.previousElementSibling;
    const rightSide = resizer.nextElementSibling;

    let x = 0;
    let leftWidth = 0;

    const mouseDownHandler = function (e) {
      x = e.clientX;
      leftWidth = leftSide.getBoundingClientRect().width;

      document.addEventListener('mousemove', mouseMoveHandler);
      document.addEventListener('mouseup', mouseUpHandler);
    };

    const mouseMoveHandler = function (e) {
      const dx = e.clientX - x;
      const newLeftWidth = ((leftWidth + dx) * 100) / resizer.parentNode.getBoundingClientRect().width;
      if (newLeftWidth > 10 && newLeftWidth < 90) { // Set min and max widths
        leftSide.style.flexBasis = `${newLeftWidth}%`;
        rightSide.style.flexBasis = `${100 - newLeftWidth}%`;
      }
    };

    const mouseUpHandler = function () {
      document.removeEventListener('mousemove', mouseMoveHandler);
      document.removeEventListener('mouseup', mouseUpHandler);
    };

    resizer.addEventListener('mousedown', mouseDownHandler);
  });
</script>
{% endblock %}

<!-- Macros for rendering sections -->
{% macro render_section(section) %}
  <div class="info-section">
    <h2>{{ section.section_name | replace('_', ' ') | title }}</h2>
    <table class="info-table">
      {% for field in section.fields %}
        <tr>
          <th>{{ field.field_name | replace('_', ' ') | title }}</th>
          <td>
            {{ field.value if field.value is not none else 'N/A' }}
            {% if field.linked_information %}
              {{ render_linked_information(field.linked_information) }}
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </table>
  </div>
{% endmacro %}

{% macro render_linked_information(linked_info) %}
  {% if linked_info %}
    <div class="linked-information">
      <h4>Linked Information:</h4>
      {% for key, value in linked_info.items() %}
        {% if value %}
          <div class="linked-section">
            <h5>{{ key.replace('_', ' ') | title }}</h5>
            {% if value is mapping %}
              <table class="info-table nested">
                {% for subkey, subvalue in value.items() %}
                  <tr>
                    <th>{{ subkey.replace('_', ' ') | title }}</th>
                    <td>
                      {% if subvalue is mapping or (subvalue is iterable and not subvalue is string) %}
                        {{ render_nested_value(subvalue) }}
                      {% else %}
                        {{ subvalue }}
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </table>
            {% elif value is iterable and not value is string %}
              <div class="nested-block">
                {% for item in value %}
                  <div class="nested-item">
                    {% if item is mapping %}
                      {{ render_nested_value(item) }}
                    {% else %}
                      {{ item }}
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% else %}
              {{ value }}
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
{% endmacro %}

{% macro render_nested_value(value) %}
  {% if value is mapping %}
    <table class="info-table nested">
      {% for subkey, subvalue in value.items() %}
        <tr>
          <th>{{ subkey.replace('_', ' ') | title }}</th>
          <td>
            {% if subvalue is mapping or (subvalue is iterable and not subvalue is string) %}
              {{ render_nested_value(subvalue) }}
            {% else %}
              {{ subvalue }}
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </table>
  {% elif value is iterable and not value is string %}
    <div class="nested-block">
      {% for item in value %}
        <div class="nested-item">
          {% if item is mapping %}
            {{ render_nested_value(item) }}
          {% else %}
            {{ item }}
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    {{ value }}
  {% endif %}
{% endmacro %}
