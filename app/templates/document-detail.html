{% extends "base.html" %}

{% macro render_json(key, value) %}
  <div class="info-section">
    <h2>{{ key|title }}</h2>
    {{ render_value(value) }}
  </div>
{% endmacro %}

{% macro render_value(value) %}
  {% if value is mapping %}
    <table class="info-table">
      {% for subkey, subvalue in value.items() %}
        <tr>
          <th>{{ subkey|title }}</th>
          <td>
            {{ render_value(subvalue) }}
          </td>
        </tr>
      {% endfor %}
    </table>
  {% elif value is iterable and value is not string %}
    <ul class="info-list">
      {% for item in value %}
        <li>
          {% if item is mapping %}
            <div class="nested-mapping">
              {% for itemkey, itemvalue in item.items() %}
                <strong>{{ itemkey|title }}:</strong> {{ render_value(itemvalue) }}<br>
              {% endfor %}
            </div>
          {% else %}
            {{ item }}
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    {{ value if value is not none else 'N/A' }}
  {% endif %}
{% endmacro %}

{% block styles %}
<style>
  .document-detail .detail-container {
    display: flex;
    gap: 20px;
  }

  .document-detail .info-panel {
    flex: 1;
    overflow-y: auto;
    max-height: calc(100vh - 40px);
  }

  .document-detail .image-panel {
    flex: 1;
    position: sticky;
    top: 20px;
    align-self: flex-start;
  }

  #imageContainer {
    width: 100%;
    height: auto;
    max-height: calc(100vh - 100px);
    overflow: auto;
    cursor: grab;
    position: relative;
  }

  #imageContainer.active {
    cursor: grabbing;
  }

  #documentImage {
    display: block;
    transform-origin: center;
  }

  .zoom-controls,
  .adjustment-controls {
    margin-top: 10px;
  }

  .zoom-controls button,
  .adjustment-controls button {
    margin-right: 5px;
    padding: 8px 12px;
    font-size: 14px;
  }

  .adjustment-controls label {
    margin-right: 10px;
  }

  .adjustment-controls input[type="range"] {
    vertical-align: middle;
    margin-right: 10px;
  }
</style>
{% endblock %}

{% block content %}
<div class="document-detail">
  <div class="detail-container">
    <div class="info-panel">
      <div class="navigation">
        <a href="{{ url_for('index') }}?return_to_search=true" class="nav-button" title="Return to Search Results">
            <span>Search</span>
        </a>
        <a href="{{ prev_id and url_for('document_detail', doc_id=prev_id, search_id=search_id) or '#' }}" class="nav-button {{ 'disabled' if not prev_id else '' }}" title="Previous Result">
            <span>Previous</span>
        </a>
        <a href="{{ url_for('index') }}" class="nav-button" title="Home">
            <span>Home</span>
        </a>
        <a href="{{ next_id and url_for('document_detail', doc_id=next_id, search_id=search_id) or '#' }}" class="nav-button {{ 'disabled' if not next_id else '' }}" title="Next Result">
            <span>Next</span>
        </a>
      </div>

      <h1>{{ document.get('filename', 'Untitled Document') }}</h1>

      <div class="info-container">
        {% for key, value in document.items() %}
          {% if key != '_id' and key != 'filename' %}
            {{ render_json(key, value) }}
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <div class="image-panel">
      {% if image_exists %}
        <div id="imageContainer">
          <img id="documentImage" src="{{ url_for('serve_image', filename=image_path | urlencode) }}" alt="Document Image">
        </div>
        <div class="zoom-controls">
          <button id="rotateLeft">Rotate Left</button>
          <button id="rotateRight">Rotate Right</button>
          <button id="zoomIn">Zoom In</button>
          <button id="zoomOut">Zoom Out</button>
          <button id="resetZoom">Reset</button>
        </div>
        <div class="adjustment-controls">
          <label for="brightnessRange">Brightness:</label>
          <input type="range" id="brightnessRange" min="0.5" max="1.5" step="0.1" value="1">
          <label for="contrastRange">Contrast:</label>
          <input type="range" id="contrastRange" min="0.5" max="2" step="0.1" value="1">
          <label for="saturationRange">Saturation:</label>
          <input type="range" id="saturationRange" min="0" max="3" step="0.1" value="1">
          <label for="hueRange">Hue Rotation:</label>
          <input type="range" id="hueRange" min="0" max="360" step="10" value="0">
          <label for="blurRange">Blur:</label>
          <input type="range" id="blurRange" min="0" max="10" step="1" value="0">
          <button id="sharpenBtn">Sharpen</button>
          <button id="grayscaleBtn">Grayscale</button>
          <button id="sepiaBtn">Sepia</button>
          <button id="invertBtn">Invert Colors</button>
          <button id="flipHorizontalBtn">Flip Horizontal</button>
          <button id="flipVerticalBtn">Flip Vertical</button>
          <button id="resetAllBtn">Reset All</button>
        </div>
        <!-- Include SVG filter definitions for sharpening -->
        <svg width="0" height="0">
          <filter id="sharpen">
            <feConvolveMatrix order="3" kernelMatrix="0 -1 0 -1 5 -1 0 -1 0"></feConvolveMatrix>
          </filter>
        </svg>
      {% else %}
        <div class="placeholder-image">
          <p>Image not found: {{ image_path }}</p>
        </div>
      {% endif %}
    </div>
    
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    let scale = 1;
    let rotation = 0;
    const ZOOM_STEP = 0.1;
    const MAX_SCALE = 3;
    const MIN_SCALE = 0.5;

    // Variables for filters
    const brightnessRange = document.getElementById('brightnessRange');
    const contrastRange = document.getElementById('contrastRange');
    const saturationRange = document.getElementById('saturationRange');
    const hueRange = document.getElementById('hueRange');
    const blurRange = document.getElementById('blurRange');
    const sharpenBtn = document.getElementById('sharpenBtn');
    const grayscaleBtn = document.getElementById('grayscaleBtn');
    const sepiaBtn = document.getElementById('sepiaBtn');
    const invertBtn = document.getElementById('invertBtn');
    const flipHorizontalBtn = document.getElementById('flipHorizontalBtn');
    const flipVerticalBtn = document.getElementById('flipVerticalBtn');
    const resetAllBtn = document.getElementById('resetAllBtn');

    let isSharpened = false;
    let isGrayscale = false;
    let isSepia = false;
    let isInverted = false;
    let isFlippedHorizontal = false;
    let isFlippedVertical = false;

    const imageContainer = document.getElementById('imageContainer');
    const documentImage = document.getElementById('documentImage');
    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    const resetZoomBtn = document.getElementById('resetZoom');
    const rotateLeftBtn = document.getElementById('rotateLeft');
    const rotateRightBtn = document.getElementById('rotateRight');

    function setImageTransform() {
      let transforms = [];

      // Scaling
      transforms.push(`scale(${scale})`);

      // Rotation
      transforms.push(`rotate(${rotation}deg)`);

      // Flipping
      const flipScaleX = isFlippedHorizontal ? -1 : 1;
      const flipScaleY = isFlippedVertical ? -1 : 1;
      transforms.push(`scale(${flipScaleX}, ${flipScaleY})`);

      documentImage.style.transform = transforms.join(' ');
    }

    function updateFilters() {
      let filters = [];

      // Brightness
      const brightnessValue = brightnessRange.value;
      filters.push(`brightness(${brightnessValue})`);

      // Contrast
      const contrastValue = contrastRange.value;
      filters.push(`contrast(${contrastValue})`);

      // Saturation
      const saturationValue = saturationRange.value;
      filters.push(`saturate(${saturationValue})`);

      // Hue Rotation
      const hueValue = hueRange.value;
      filters.push(`hue-rotate(${hueValue}deg)`);

      // Blur
      const blurValue = blurRange.value;
      filters.push(`blur(${blurValue}px)`);

      // Grayscale and Sepia
      if (isGrayscale) {
        filters.push(`grayscale(1)`);
      } else if (isSepia) {
        filters.push(`sepia(1)`);
      }

      // Invert
      if (isInverted) {
        filters.push(`invert(1)`);
      }

      // Apply Sharpen Filter if enabled
      if (isSharpened) {
        documentImage.style.filter = filters.join(' ') + ' url(#sharpen)';
      } else {
        documentImage.style.filter = filters.join(' ');
      }
    }

    function zoomIn() {
      if (scale < MAX_SCALE) {
        scale += ZOOM_STEP;
        setImageTransform();
      }
    }

    function zoomOut() {
      if (scale > MIN_SCALE) {
        scale -= ZOOM_STEP;
        setImageTransform();
      }
    }

    function resetZoom() {
      scale = 1;
      rotation = 0;
      setImageTransform();
    }

    function rotateLeft() {
      rotation -= 90;
      setImageTransform();
    }

    function rotateRight() {
      rotation += 90;
      setImageTransform();
    }

    zoomInBtn.addEventListener('click', zoomIn);
    zoomOutBtn.addEventListener('click', zoomOut);
    resetZoomBtn.addEventListener('click', resetZoom);
    rotateLeftBtn.addEventListener('click', rotateLeft);
    rotateRightBtn.addEventListener('click', rotateRight);

    // Event listeners for filters
    brightnessRange.addEventListener('input', updateFilters);
    contrastRange.addEventListener('input', updateFilters);
    saturationRange.addEventListener('input', updateFilters);
    hueRange.addEventListener('input', updateFilters);
    blurRange.addEventListener('input', updateFilters);

    sharpenBtn.addEventListener('click', () => {
      isSharpened = !isSharpened;
      updateFilters();
      sharpenBtn.textContent = isSharpened ? 'Unsharpen' : 'Sharpen';
    });

    grayscaleBtn.addEventListener('click', () => {
      isGrayscale = !isGrayscale;
      isSepia = false;
      updateFilters();
    });

    sepiaBtn.addEventListener('click', () => {
      isSepia = !isSepia;
      isGrayscale = false;
      updateFilters();
    });

    invertBtn.addEventListener('click', () => {
      isInverted = !isInverted;
      updateFilters();
    });

    flipHorizontalBtn.addEventListener('click', () => {
      isFlippedHorizontal = !isFlippedHorizontal;
      setImageTransform();
    });

    flipVerticalBtn.addEventListener('click', () => {
      isFlippedVertical = !isFlippedVertical;
      setImageTransform();
    });

    resetAllBtn.addEventListener('click', () => {
      // Reset transformations
      scale = 1;
      rotation = 0;
      isFlippedHorizontal = false;
      isFlippedVertical = false;
      setImageTransform();

      // Reset filters
      brightnessRange.value = 1;
      contrastRange.value = 1;
      saturationRange.value = 1;
      hueRange.value = 0;
      blurRange.value = 0;
      isSharpened = false;
      isGrayscale = false;
      isSepia = false;
      isInverted = false;
      updateFilters();

      // Reset button texts
      sharpenBtn.textContent = 'Sharpen';
    });

    // Dragging functionality
    let isDragging = false;
    let startX, startY, scrollLeft, scrollTop;

    imageContainer.addEventListener('mousedown', (e) => {
      isDragging = true;
      imageContainer.classList.add('active');
      startX = e.pageX - imageContainer.offsetLeft;
      startY = e.pageY - imageContainer.offsetTop;
      scrollLeft = imageContainer.scrollLeft;
      scrollTop = imageContainer.scrollTop;
    });

    imageContainer.addEventListener('mouseleave', () => {
      isDragging = false;
      imageContainer.classList.remove('active');
    });

    imageContainer.addEventListener('mouseup', () => {
      isDragging = false;
      imageContainer.classList.remove('active');
    });

    imageContainer.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      e.preventDefault();
      const x = e.pageX - imageContainer.offsetLeft;
      const y = e.pageY - imageContainer.offsetTop;
      const walkX = x - startX;
      const walkY = y - startY;
      imageContainer.scrollLeft = scrollLeft - walkX;
      imageContainer.scrollTop = scrollTop - walkY;
    });
  });
</script>
{% endblock %}
