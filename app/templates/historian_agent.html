{% extends 'base.html' %}
{% block title %}Historian Agent Â· Historical Document Reader{% endblock %}

{% block content %}
<div class="container historian-agent">
    <div class="agent-hero">
        <span class="agent-hero__badge">Powered By Primary Sources</span>
        <h1>Historian Agent</h1>
        <p class="agent-hero__subtitle">Ask natural language questions about the archives and receive sourced answers from the Historian Agent.</p>
    </div>
    <section class="agent-panel" data-agent-enabled="{{ 'true' if agent_config_payload.enabled else 'false' }}" data-agent-error="{{ 'true' if agent_error else 'false' }}">
        
        
        <!-- NEW: Method selector -->
        <div class="agent-method-selector">
            <label for="agentMethod">Query Method:</label>
            <select id="agentMethod" name="method" data-help="Choose the analysis depth and speed profile for this question.">
                <option value="basic" selected>Good (Fast)</option>
                <option value="adversarial">Better (Monitored)</option>
                <option value="tiered">Best (Tiered)</option>
                <!-- Added Tier 0 option so corpus exploration can be selected from the UI. -->
                <option value="tier0">Tier 0 (Corpus Exploration)</option>
            </select>
            <span class="agent-method-hint" id="agentMethodHint">
                Best quality with confidence-based escalation (~20-60s)
            </span>
        </div>

        <div class="agent-tier0-lens" id="tier0ResearchLensContainer" hidden>
            <label for="tier0ResearchLens">Tier 0 Research Lens (optional):</label>
            <input
                id="tier0ResearchLens"
                name="tier0_research_lens"
                type="text"
                placeholder="e.g., ethnicity, gender, occupation, disability by department"
                data-help="Optionally focus Tier 0 corpus exploration on specific research dimensions."
            >
            <small>Comma-separated priorities; Tier 0 will focus on these when evidence exists.</small> <!-- Added explicit guidance so users can prepopulate historian interests before corpus exploration. -->
        </div>

        <!-- NEW: Terminal-style debug console -->
        <div class="agent-debug-console" id="agentDebugConsole">
            <div class="agent-debug-header">
                <span class="agent-debug-title">Pipeline Debug Log</span>
                <button type="button" class="agent-debug-clear" id="agentDebugClear" data-help="Clear messages from the live pipeline debug log.">Clear</button>
            </div>
            <div class="agent-debug-output" id="agentDebugOutput"></div>
        </div>

        <div class="agent-history" id="agentHistory" aria-live="polite" aria-label="Historian Agent conversation"></div>
        
        <form id="agentForm" class="agent-form" novalidate>
            <label for="agentQuestion" class="sr-only">Ask a question</label>
            <textarea id="agentQuestion" name="question" rows="4" placeholder="Ask the Historian Agent about the archives..." data-help="Type your archive research question here."></textarea>
            <div class="agent-suggestions" aria-label="Suggested questions">
                <button type="button" class="agent-suggestion" data-question="Summarize the key events mentioned in the May 1944 archive." data-autosend="true" aria-label="Ask about May 1944" data-help="Send a starter prompt about major May 1944 events.">May 1944 highlights</button>
                <button type="button" class="agent-suggestion" data-question="Who are the main people involved in the selected document?" data-autosend="true" aria-label="Ask about people" data-help="Send a starter prompt focused on key individuals.">People involved</button>
                <button type="button" class="agent-suggestion" data-question="Give me context for the referenced operation." data-autosend="true" aria-label="Ask for context" data-help="Send a starter prompt requesting broader operational context.">Operational context</button>
            </div>
            <div class="agent-actions">
                <div class="agent-status" id="agentStatus" role="status" aria-live="polite" hidden>
                    <span class="agent-status__dot" aria-hidden="true"></span>
                    <span id="agentStatusText">Working...</span>
                </div>
                <button type="submit" data-help="Submit your question to the Historian Agent.">Send</button>
                <button type="button" id="agentReset" class="secondary" data-help="Clear the conversation history and start over.">Reset conversation</button>
            </div>
        </form>
        
        <!-- NEW: Performance metrics display -->
        <div class="agent-metrics" id="agentMetrics" hidden>
            <h3>Performance Metrics</h3>
            <div class="agent-metrics-grid" id="agentMetricsGrid"></div>
        </div>

        <div class="agent-sources" id="agentSources" hidden>
            <h2>Sources</h2>
            <ul id="agentSourcesList"></ul>
        </div>
    </section>
    
</div>
<script id="historianAgentConfigData" type="application/json">{{ agent_config_payload | tojson }}</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="{{ url_for('static', filename='historian_agent.js') }}"></script>
{% endblock %}
