{% extends 'base.html' %}
{% block title %}Historian Agent Â· Historical Document Reader{% endblock %}

{% block content %}
<div class="container historian-agent">
    <div class="agent-hero">
        <span class="agent-hero__badge">Powered By Primary Sources</span>
        <h1>Historian Agent</h1>
        <p class="agent-hero__subtitle">Ask natural language questions about the archives and receive sourced answers from the Historian Agent.</p>
    </div>
    <!-- Added explicit help text for core Historian controls to match the network-analysis tooltip standard. -->
    <section class="agent-panel" data-agent-enabled="{{ 'true' if agent_config_payload.enabled else 'false' }}" data-agent-error="{{ 'true' if agent_error else 'false' }}" data-help="Submit a question, monitor backend logs, and review cited source documents.">
        
        
        <!-- NEW: Method selector -->
        <div class="agent-method-selector">
            <label for="agentMethod">Query Method:</label>
            <select id="agentMethod" name="method" data-help="Quick: fast retrieval, no verification. Verified: adversarial cross-check. Deep: tiered escalation with confidence scoring.">
                <!-- Updated labels to plain-language quality/speed tradeoffs while preserving method values. -->
                <option value="basic">Quick - ~5s, direct retrieval</option>
                <option value="adversarial">Verified - ~15s, cross-checked</option>
                <option value="tiered" selected>Deep - ~30-60s, confidence-based</option>
            </select>
            <span class="agent-method-hint" id="agentMethodHint">
                Retrieves evidence, escalates to deeper analysis if confidence is low.
            </span>
        </div>

        <!-- Replaced always-open terminal block with a collapsible activity stream that stays quiet when idle. -->
        <div class="agent-activity" id="agentActivity">
            <div class="agent-activity__header">
                <span class="agent-activity__indicator is-idle" id="activityIndicator" aria-hidden="true"></span>
                <span class="agent-activity__label" id="activityLabel">Ready</span>
                <button type="button"
                        class="agent-activity__toggle"
                        id="activityToggle"
                        aria-expanded="false"
                        aria-controls="agentDebugOutput"
                        data-help="Expand or collapse the backend activity log.">
                    Show log
                </button>
                <button type="button"
                        class="agent-activity__clear"
                        id="agentDebugClear"
                        hidden
                        data-help="Clear the currently displayed backend log entries.">
                    Clear
                </button>
            </div>
            <div class="agent-activity__log agent-debug-output" id="agentDebugOutput" role="log" aria-live="polite" hidden></div>
        </div>

        <div class="agent-history" id="agentHistory" aria-live="polite" aria-label="Historian Agent conversation"></div>
        
        <form id="agentForm" class="agent-form" novalidate>
            <label for="agentQuestion" class="sr-only">Ask a question</label>
            <textarea id="agentQuestion" name="question" rows="4" placeholder="Ask the Historian Agent about the archives..." data-help="Enter a focused research question. Include dates, names, or places for better retrieval."></textarea>
            <!-- Keep refinement control visible on-page so users can discover and toggle it while composing questions. -->
            <label class="agent-refinement-toggle" for="refinementToggleInline" data-help="If enabled, short/vague prompts open refinement suggestions before search runs.">
                <input type="checkbox" id="refinementToggleInline" checked>
                <span>Suggest refinements</span>
            </label>
            <div class="agent-suggestions" aria-label="Suggested questions">
                <button type="button" class="agent-suggestion" data-question="Summarize the key events mentioned in the May 1944 archive." data-autosend="true" aria-label="Ask about May 1944" data-help="Insert and auto-send a sample question about timeline events in May 1944.">May 1944 highlights</button>
                <button type="button" class="agent-suggestion" data-question="Who are the main people involved in the selected document?" data-autosend="true" aria-label="Ask about people" data-help="Insert and auto-send a sample question focused on key people in context.">People involved</button>
                <button type="button" class="agent-suggestion" data-question="Give me context for the referenced operation." data-autosend="true" aria-label="Ask for context" data-help="Insert and auto-send a sample question for broader operational background.">Operational context</button>
            </div>
            <div class="agent-actions">
                <div class="agent-status" id="agentStatus" role="status" aria-live="polite" hidden>
                    <span class="agent-status__dot" aria-hidden="true"></span>
                    <span id="agentStatusText">Working...</span>
                </div>
                <button type="submit" data-help="Send your current question to the selected Historian method.">Send</button>
                <button type="button" id="agentReset" class="secondary" data-help="Clear conversation history and start a fresh session.">Reset conversation</button>
            </div>
        </form>

        <!-- Refinement prompt shown before running short/vague queries when enabled. -->
        <div id="refinementModal" class="agent-refinement-modal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="refinementTitle">
            <div class="agent-refinement-modal__inner">
                <h2 id="refinementTitle">Refine your question</h2>
                <p>Before searching, consider narrowing your question for more precise results.</p>
                <div class="agent-refinement-suggestions" id="refinementSuggestions"></div>
                <div class="agent-refinement-modal__actions">
                    <button type="button" id="searchAsIs" class="secondary" data-help="Run your current wording immediately without edits.">Search as typed</button>
                    <button type="button" id="searchRefined" data-help="Close suggestions and return to the question box to refine wording.">Search refined question</button>
                </div>
            </div>
        </div>
        
    </section>
    
</div>
<script id="historianAgentConfigData" type="application/json">{{ agent_config_payload | tojson }}</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/marked.min.js') }}"></script>
<script src="{{ url_for('static', filename='historian_agent.js') }}"></script>
{% endblock %}
