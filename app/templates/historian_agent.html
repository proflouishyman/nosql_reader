{% extends 'base.html' %}
{% block title %}Historian Agent Â· Historical Document Reader{% endblock %}

{% block content %}
<div class="container historian-agent">
    <div class="agent-hero">
        <span class="agent-hero__badge">RAG powered</span>
        <h1>Historian Agent</h1>
        <p class="agent-hero__subtitle">Ask natural language questions about the archives and receive sourced answers from the Historian Agent.</p>
    </div>
    <section class="agent-panel" data-agent-enabled="{{ 'true' if agent_config_payload.enabled else 'false' }}" data-agent-error="{{ 'true' if agent_error else 'false' }}">
        <div id="agentErrorBanner" class="agent-alert agent-alert--error" {% if not agent_error %}hidden{% endif %}>{{ agent_error }}</div>
        <div id="agentDisabledBanner" class="agent-alert" {% if agent_config_payload.enabled and not agent_error %}hidden{% endif %}>
            The Historian agent is disabled. Adjust the configuration from the settings page to continue.
        </div>
        
        <!-- NEW: Method selector -->
        <div class="agent-method-selector">
            <label for="agentMethod">Query Method:</label>
            <select id="agentMethod" name="method">
                <option value="basic">Good (Fast)</option>
                <option value="adversarial">Better (Monitored)</option>
                <option value="tiered" selected>Best (Tiered)</option>
            </select>
            <span class="agent-method-hint" id="agentMethodHint">
                Best quality with confidence-based escalation (~20-60s)
            </span>
        </div>

        <!-- NEW: Terminal-style debug console -->
        <div class="agent-debug-console" id="agentDebugConsole">
            <div class="agent-debug-header">
                <span class="agent-debug-title">Pipeline Debug Log</span>
                <button type="button" class="agent-debug-clear" id="agentDebugClear">Clear</button>
            </div>
            <div class="agent-debug-output" id="agentDebugOutput"></div>
        </div>

        <div class="agent-history" id="agentHistory" aria-live="polite" aria-label="Historian Agent conversation"></div>
        
        <form id="agentForm" class="agent-form" novalidate>
            <label for="agentQuestion" class="sr-only">Ask a question</label>
            <textarea id="agentQuestion" name="question" rows="4" placeholder="Ask the Historian Agent about the archives..."></textarea>
            <div class="agent-suggestions" aria-label="Suggested questions">
                <button type="button" class="agent-suggestion" data-question="Summarize the key events mentioned in the May 1944 archive." data-autosend="true" aria-label="Ask about May 1944">May 1944 highlights</button>
                <button type="button" class="agent-suggestion" data-question="Who are the main people involved in the selected document?" data-autosend="true" aria-label="Ask about people">People involved</button>
                <button type="button" class="agent-suggestion" data-question="Give me context for the referenced operation." data-autosend="true" aria-label="Ask for context">Operational context</button>
            </div>
            <div class="agent-actions">
                <div class="agent-status" id="agentStatus" role="status" aria-live="polite" hidden>
                    <span class="agent-status__dot" aria-hidden="true"></span>
                    <span id="agentStatusText">Working...</span>
                </div>
                <button type="submit">Send</button>
                <button type="button" id="agentReset" class="secondary">Reset conversation</button>
            </div>
        </form>
        
        <!-- NEW: Performance metrics display -->
        <div class="agent-metrics" id="agentMetrics" hidden>
            <h3>Performance Metrics</h3>
            <div class="agent-metrics-grid" id="agentMetricsGrid"></div>
        </div>

        <div class="agent-sources" id="agentSources" hidden>
            <h2>Sources</h2>
            <ul id="agentSourcesList"></ul>
        </div>
    </section>
    <aside class="agent-settings-callout">
        <h2>Configure the Historian Agent</h2>
        <p>Model provider credentials, retrieval depth, and ingestion options now live on the <a href="{{ url_for('settings') }}#chatbot-settings">Settings</a> page.</p>
        <a class="button" href="{{ url_for('settings') }}#chatbot-settings">Open Historian Agent settings</a>
    </aside>
</div>
<script id="historianAgentConfigData" type="application/json">{{ agent_config_payload | tojson }}</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='historian_agent.js') }}"></script>
{% endblock %}