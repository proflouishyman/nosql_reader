{% extends 'base.html' %}
{% block title %}Historian Agent{% endblock %}

{% block content %}
<div class="container historian-agent">
    <div class="agent-hero">
        <span class="agent-hero__badge">RAG powered</span>
        <h1>Historian Agent</h1>
        <p class="agent-hero__subtitle">Ask natural language questions about the archives and receive sourced answers from the Historian Agent.</p>
    </div>
    <div class="agent-layout">
        <section class="agent-panel" data-agent-enabled="{{ 'true' if agent_config_payload.enabled else 'false' }}" data-agent-error="{{ 'true' if agent_error else 'false' }}">
            <div id="agentErrorBanner" class="agent-alert agent-alert--error" {% if not agent_error %}hidden{% endif %}>{{ agent_error }}</div>
            <div id="agentDisabledBanner" class="agent-alert" {% if agent_config_payload.enabled %}hidden{% endif %}>
                The Historian agent is disabled. Use the configuration panel to enable it.
            </div>
            <div class="agent-history" id="agentHistory" aria-live="polite" aria-label="Historian Agent conversation"></div>
            <form id="agentForm" class="agent-form" novalidate>
                <label for="agentQuestion" class="sr-only">Ask a question</label>
                <textarea id="agentQuestion" name="question" rows="4" placeholder="Ask the Historian Agent about the archives..."></textarea>
                <div class="agent-suggestions" aria-label="Suggested questions">
                    <button type="button" class="agent-suggestion" data-question="Summarize the key events mentioned in the May 1944 archive." data-autosend="true" aria-label="Ask about May 1944">May 1944 highlights</button>
                    <button type="button" class="agent-suggestion" data-question="Who are the main people involved in the selected document?" data-autosend="true" aria-label="Ask about people">People involved</button>
                    <button type="button" class="agent-suggestion" data-question="Give me context for the referenced operation." data-autosend="true" aria-label="Ask for context">Operational context</button>
                </div>
                <div class="agent-actions">
                    <div class="agent-status" id="agentStatus" role="status" aria-live="polite" hidden>
                        <span class="agent-status__dot" aria-hidden="true"></span>
                        <span>Working...</span>
                    </div>
                    <button type="submit">Send</button>
                    <button type="button" id="agentReset" class="secondary">Reset conversation</button>
                </div>
            </form>
            <div class="agent-sources" id="agentSources" hidden>
                <h2>Sources</h2>
                <ul id="agentSourcesList"></ul>
            </div>
        </section>
        <aside class="agent-settings" id="agentSettings" data-config-endpoint="{{ url_for('historian_agent_config') }}">
            <div class="agent-settings__header">
                <h2>Configuration</h2>
                <p>Tune model provider, prompts, and retrieval behaviour without leaving the interface.</p>
            </div>
            <form id="agentSettingsForm" class="agent-settings__form" novalidate>
                <div class="form-field form-field--toggle">
                    <label for="agentEnabled">
                        <span>Enable Historian Agent</span>
                        <input type="checkbox" id="agentEnabled" name="enabled" {% if agent_config_payload.enabled %}checked{% endif %}>
                    </label>
                    <p class="form-field__hint">Disable this toggle to pause the Historian Agent for your session.</p>
                </div>
                <div class="form-field">
                    <label for="agentModelProvider">Model provider</label>
                    <select id="agentModelProvider" name="model_provider">
                        {% for option in provider_options %}
                        <option value="{{ option.value }}" {% if option.value == agent_config_payload.model_provider %}selected{% endif %}>{{ option.label }}</option>
                        {% endfor %}
                    </select>
                    <p class="form-field__hint">Swap between locally hosted Ollama models or cloud providers like OpenAI.</p>
                </div>
                <div class="agent-provider agent-provider--ollama" data-provider="ollama" {% if agent_config_payload.model_provider != 'ollama' %}hidden{% endif %}>
                    <div class="form-field">
                        <label for="agentOllamaBaseUrl">Ollama base URL</label>
                        <input type="text" id="agentOllamaBaseUrl" name="ollama_base_url" value="{{ agent_config_payload.ollama_base_url }}" placeholder="http://localhost:11434">
                        <p class="form-field__hint">Point to your Ollama host when running locally or within your network.</p>
                    </div>
                </div>
                <div class="agent-provider agent-provider--openai" data-provider="openai" {% if agent_config_payload.model_provider != 'openai' %}hidden{% endif %}>
                    <div class="form-field">
                        <label for="agentOpenAiKey">OpenAI API key</label>
                        <input type="password" id="agentOpenAiKey" name="openai_api_key" value="" placeholder="{% if agent_config_payload.openai_api_key_present %}API key configured{% else %}Enter OpenAI API key{% endif %}">
                        <p class="form-field__hint">Keys are stored in your Flask session. Leave blank to keep the current key.</p>
                    </div>
                </div>
                <div class="form-field">
                    <label for="agentModelName">Model name</label>
                    <input type="text" id="agentModelName" name="model_name" value="{{ agent_config_payload.model_name }}" placeholder="llama3">
                </div>
                <div class="form-field form-field--grid">
                    <div>
                        <label for="agentTemperature">Temperature</label>
                        <input type="number" id="agentTemperature" name="temperature" step="0.1" min="0" max="2" value="{{ '%.2f'|format(agent_config_payload.temperature) }}">
                    </div>
                    <div>
                        <label for="agentContextDocuments">Context documents</label>
                        <input type="number" id="agentContextDocuments" name="max_context_documents" min="1" value="{{ agent_config_payload.max_context_documents }}">
                    </div>
                </div>
                <div class="form-field">
                    <label for="agentSystemPrompt">System prompt</label>
                    <textarea id="agentSystemPrompt" name="system_prompt" rows="4">{{ agent_config_payload.system_prompt }}</textarea>
                </div>
                <div class="form-field">
                    <label for="agentContextFields">Context fields</label>
                    <textarea id="agentContextFields" name="context_fields" rows="3">{{ agent_config_payload.context_fields | join('\n') }}</textarea>
                    <p class="form-field__hint">Provide the MongoDB document fields to inspect, one per line.</p>
                </div>
                <div class="form-field">
                    <label for="agentSummaryField">Summary fallback field</label>
                    <input type="text" id="agentSummaryField" name="summary_field" value="{{ agent_config_payload.summary_field }}" placeholder="content">
                </div>
                <div class="form-field form-field--toggle">
                    <label for="agentAllowFallback">
                        <span>Allow summary fallback</span>
                        <input type="checkbox" id="agentAllowFallback" name="allow_general_fallback" {% if agent_config_payload.allow_general_fallback %}checked{% endif %}>
                    </label>
                    <p class="form-field__hint">Use the summary field when direct context snippets are unavailable.</p>
                </div>
                <div class="agent-settings__actions">
                    <button type="submit">Save configuration</button>
                    <button type="button" id="agentSettingsReset" class="secondary">Reset to defaults</button>
                </div>
                <div class="agent-config-status" id="agentConfigStatus" role="status" aria-live="polite" hidden></div>
            </form>
        </aside>
    </div>
</div>
<script id="historianAgentConfigData" type="application/json">{{ agent_config_payload | tojson }}</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
    'use strict';

    const configDataEl = document.getElementById('historianAgentConfigData');
    let agentConfig = null;
    if (configDataEl) {
        try {
            agentConfig = JSON.parse(configDataEl.textContent);
        } catch (error) {
            console.warn('Failed to parse Historian Agent config payload', error);
        }
    }

    const agentPanel = document.querySelector('.agent-panel');
    const agentSettingsRoot = document.getElementById('agentSettings');
    const configEndpoint = agentSettingsRoot ? agentSettingsRoot.dataset.configEndpoint : null;

    const form = document.getElementById('agentForm');
    const questionInput = document.getElementById('agentQuestion');
    const historyContainer = document.getElementById('agentHistory');
    const sourcesContainer = document.getElementById('agentSources');
    const sourcesList = document.getElementById('agentSourcesList');
    const resetButton = document.getElementById('agentReset');
    const status = document.getElementById('agentStatus');
    const suggestionButtons = Array.from(document.querySelectorAll('.agent-suggestion'));
    const submitButton = form ? form.querySelector('button[type="submit"]') : null;
    const disabledBanner = document.getElementById('agentDisabledBanner');
    const errorBanner = document.getElementById('agentErrorBanner');

    const settingsForm = document.getElementById('agentSettingsForm');
    const configStatus = document.getElementById('agentConfigStatus');
    const providerSelect = document.getElementById('agentModelProvider');
    const enabledToggle = document.getElementById('agentEnabled');
    const ollamaSection = agentSettingsRoot ? agentSettingsRoot.querySelector('.agent-provider--ollama') : null;
    const openaiSection = agentSettingsRoot ? agentSettingsRoot.querySelector('.agent-provider--openai') : null;
    const ollamaBaseUrlInput = document.getElementById('agentOllamaBaseUrl');
    const openAiKeyInput = document.getElementById('agentOpenAiKey');
    const modelNameInput = document.getElementById('agentModelName');
    const temperatureInput = document.getElementById('agentTemperature');
    const contextDocsInput = document.getElementById('agentContextDocuments');
    const systemPromptInput = document.getElementById('agentSystemPrompt');
    const contextFieldsInput = document.getElementById('agentContextFields');
    const summaryFieldInput = document.getElementById('agentSummaryField');
    const fallbackToggle = document.getElementById('agentAllowFallback');
    const resetConfigButton = document.getElementById('agentSettingsReset');

    let conversationId = null;
    let isSubmitting = false;
    let agentEnabled = agentConfig ? Boolean(agentConfig.enabled) : true;
    let hasAgentError = agentPanel ? agentPanel.dataset.agentError === 'true' : false;

    function updateProviderSections(provider) {
        if (ollamaSection) {
            ollamaSection.hidden = provider !== 'ollama';
        }
        if (openaiSection) {
            openaiSection.hidden = provider !== 'openai';
        }
    }

    function markConfigStatus(message, type) {
        if (!configStatus) return;
        configStatus.textContent = message || '';
        configStatus.hidden = !message;
        if (!message) {
            delete configStatus.dataset.status;
            return;
        }
        configStatus.dataset.status = type || 'info';
    }

    function setConfigSubmitting(active) {
        if (!settingsForm) return;
        const saveButton = settingsForm.querySelector('button[type="submit"]');
        if (saveButton) saveButton.disabled = active;
        if (resetConfigButton) resetConfigButton.disabled = active;
    }

    function syncInteractionState() {
        const canInteract = agentEnabled && !hasAgentError;
        if (!isSubmitting) {
            if (submitButton) submitButton.disabled = !canInteract;
            if (questionInput) questionInput.toggleAttribute('disabled', !canInteract);
            suggestionButtons.forEach((button) => {
                button.disabled = !canInteract;
            });
        }
        if (disabledBanner) {
            disabledBanner.hidden = agentEnabled;
        }
        if (agentPanel) {
            agentPanel.classList.toggle('agent-panel--disabled', !canInteract);
        }
    }

    function syncAgentError(message) {
        hasAgentError = Boolean(message);
        if (errorBanner) {
            if (message) {
                errorBanner.textContent = message;
                errorBanner.hidden = false;
            } else {
                errorBanner.textContent = '';
                errorBanner.hidden = true;
            }
        }
        syncInteractionState();
    }

    function applyConfig(config) {
        if (!config) return;
        agentConfig = config;
        agentEnabled = Boolean(config.enabled);
        if (enabledToggle) {
            enabledToggle.checked = agentEnabled;
        }
        if (providerSelect && config.model_provider) {
            providerSelect.value = config.model_provider;
        }
        updateProviderSections(config.model_provider);
        if (modelNameInput) {
            modelNameInput.value = config.model_name || '';
        }
        if (temperatureInput) {
            temperatureInput.value = config.temperature === undefined ? '' : `${config.temperature}`;
        }
        if (contextDocsInput) {
            contextDocsInput.value = config.max_context_documents === undefined ? '' : `${config.max_context_documents}`;
        }
        if (systemPromptInput) {
            systemPromptInput.value = config.system_prompt || '';
        }
        if (contextFieldsInput) {
            const fields = Array.isArray(config.context_fields) ? config.context_fields : [];
            contextFieldsInput.value = fields.join('\n');
        }
        if (summaryFieldInput) {
            summaryFieldInput.value = config.summary_field || '';
        }
        if (fallbackToggle) {
            fallbackToggle.checked = Boolean(config.allow_general_fallback);
        }
        if (ollamaBaseUrlInput) {
            ollamaBaseUrlInput.value = config.ollama_base_url || '';
        }
        if (openAiKeyInput) {
            openAiKeyInput.value = '';
            openAiKeyInput.placeholder = config.openai_api_key_present ? 'API key configured' : 'Enter OpenAI API key';
        }
        syncInteractionState();
    }

    function setSubmitting(active) {
        isSubmitting = active;
        if (status) {
            status.hidden = !active;
        }
        if (agentPanel) {
            agentPanel.classList.toggle('is-loading', active);
        }
        if (active) {
            if (submitButton) submitButton.disabled = true;
            if (questionInput) questionInput.toggleAttribute('disabled', true);
            suggestionButtons.forEach((button) => {
                button.disabled = true;
            });
        } else {
            syncInteractionState();
        }
    }

    function appendMessage(role, content) {
        if (!historyContainer) return;
        const entry = document.createElement('div');
        entry.className = `agent-message agent-message--${role}`;
        const avatar = document.createElement('div');
        avatar.className = 'agent-message__avatar';
        avatar.setAttribute('aria-hidden', 'true');
        avatar.textContent = role === 'assistant' ? 'HA' : 'You';
        const bodyWrapper = document.createElement('div');
        bodyWrapper.className = 'agent-message__body';
        const label = document.createElement('div');
        label.className = 'agent-message__role';
        label.textContent = role === 'assistant' ? 'Historian Agent' : 'You';
        const body = document.createElement('div');
        body.className = 'agent-message__content';
        body.textContent = content;
        bodyWrapper.appendChild(label);
        bodyWrapper.appendChild(body);
        entry.appendChild(avatar);
        entry.appendChild(bodyWrapper);
        historyContainer.appendChild(entry);
        historyContainer.scrollTop = historyContainer.scrollHeight;
    }

    function renderSources(sources) {
        if (!sourcesContainer || !sourcesList) return;
        sourcesList.innerHTML = '';
        if (!Array.isArray(sources) || !sources.length) {
            sourcesContainer.hidden = true;
            return;
        }
        sourcesContainer.hidden = false;
        sources.forEach((source) => {
            const item = document.createElement('li');
            const heading = document.createElement('div');
            heading.className = 'agent-source__title';
            const reference = source.reference ? `${source.reference} ` : '';
            heading.textContent = `${reference}${source.title || 'Source'}`;
            const snippet = document.createElement('p');
            snippet.className = 'agent-source__snippet';
            snippet.textContent = source.snippet || '';
            item.appendChild(heading);
            item.appendChild(snippet);
            sourcesList.appendChild(item);
        });
    }

    function clearConversation() {
        conversationId = null;
        if (historyContainer) {
            historyContainer.innerHTML = '';
        }
        renderSources([]);
    }

    async function submitQuestion(evt) {
        evt.preventDefault();
        if (isSubmitting || !agentEnabled || hasAgentError) {
            return;
        }
        const question = questionInput ? questionInput.value.trim() : '';
        if (!question) {
            if (questionInput) {
                questionInput.focus();
            }
            return;
        }
        appendMessage('user', question);
        if (questionInput) {
            questionInput.value = '';
        }
        setSubmitting(true);

        try {
            const response = await fetch('{{ url_for('historian_agent_query') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question, conversation_id: conversationId })
            });
            const payload = await response.json();
            if (!response.ok) {
                appendMessage('assistant', payload.error || 'The agent could not complete the request.');
                return;
            }
            conversationId = payload.conversation_id;
            appendMessage('assistant', payload.answer);
            renderSources(payload.sources);
        } catch (error) {
            console.error('Historian Agent query failed', error);
            appendMessage('assistant', 'An unexpected error occurred.');
        } finally {
            setSubmitting(false);
        }
    }

    async function resetConversation(evt) {
        if (evt) {
            evt.preventDefault();
        }
        clearConversation();
        try {
            await fetch('{{ url_for('historian_agent_query') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh: true })
            });
        } catch (error) {
            console.warn('Failed to reset agent session', error);
        }
        if (questionInput) {
            questionInput.value = '';
            questionInput.focus();
        }
    }

    function buildConfigPayload() {
        const payload = {};
        if (enabledToggle) payload.enabled = enabledToggle.checked;
        if (providerSelect) payload.model_provider = providerSelect.value;
        if (modelNameInput) payload.model_name = modelNameInput.value.trim();
        if (temperatureInput) payload.temperature = temperatureInput.value;
        if (contextDocsInput) payload.max_context_documents = contextDocsInput.value;
        if (systemPromptInput) payload.system_prompt = systemPromptInput.value;
        if (contextFieldsInput) payload.context_fields = contextFieldsInput.value;
        if (summaryFieldInput) payload.summary_field = summaryFieldInput.value.trim();
        if (fallbackToggle) payload.allow_general_fallback = fallbackToggle.checked;
        if (ollamaBaseUrlInput) payload.ollama_base_url = ollamaBaseUrlInput.value.trim();
        if (openAiKeyInput) payload.openai_api_key = openAiKeyInput.value.trim();
        return payload;
    }

    function handleConfigResponse(data, fallbackMessage) {
        if (!data || !data.config) {
            markConfigStatus('Configuration updated, but no details were returned.', 'info');
            return;
        }
        applyConfig(data.config);
        if (typeof data.agent_error === 'string' && data.agent_error) {
            markConfigStatus(data.agent_error, 'error');
        } else {
            markConfigStatus(data.message || fallbackMessage, 'success');
        }
        syncAgentError(data.agent_error || null);
        clearConversation();
    }

    if (form) {
        form.addEventListener('submit', submitQuestion);
    }

    if (resetButton) {
        resetButton.addEventListener('click', resetConversation);
    }

    if (enabledToggle) {
        enabledToggle.addEventListener('change', () => {
            agentEnabled = enabledToggle.checked;
            syncInteractionState();
        });
    }

    if (providerSelect) {
        providerSelect.addEventListener('change', () => {
            updateProviderSections(providerSelect.value);
        });
    }

    if (settingsForm && configEndpoint) {
        settingsForm.addEventListener('submit', async (evt) => {
            evt.preventDefault();
            markConfigStatus('Saving configuration…', 'progress');
            setConfigSubmitting(true);
            try {
                const response = await fetch(configEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(buildConfigPayload()),
                });
                const data = await response.json();
                if (!response.ok) {
                    markConfigStatus(data.error || 'Unable to update configuration.', 'error');
                    if (typeof data.agent_error !== 'undefined') {
                        syncAgentError(data.agent_error || null);
                    }
                    return;
                }
                handleConfigResponse(data, 'Historian Agent configuration updated.');
            } catch (error) {
                console.error('Failed to update Historian Agent configuration', error);
                markConfigStatus('Failed to update configuration.', 'error');
            } finally {
                setConfigSubmitting(false);
            }
        });
    }

    if (resetConfigButton && configEndpoint) {
        resetConfigButton.addEventListener('click', async () => {
            markConfigStatus('Restoring defaults…', 'progress');
            setConfigSubmitting(true);
            try {
                const response = await fetch(configEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reset: true }),
                });
                const data = await response.json();
                if (!response.ok) {
                    markConfigStatus(data.error || 'Unable to reset configuration.', 'error');
                    if (typeof data.agent_error !== 'undefined') {
                        syncAgentError(data.agent_error || null);
                    }
                    return;
                }
                handleConfigResponse(data, 'Historian Agent configuration reset to defaults.');
            } catch (error) {
                console.error('Failed to reset Historian Agent configuration', error);
                markConfigStatus('Failed to reset configuration.', 'error');
            } finally {
                setConfigSubmitting(false);
            }
        });
    }

    suggestionButtons.forEach((button) => {
        button.addEventListener('click', () => {
            if (!questionInput) return;
            const prompt = button.dataset.question || '';
            questionInput.value = prompt;
            questionInput.focus();
            if (button.dataset.autosend === 'true' && form && typeof form.requestSubmit === 'function' && agentEnabled && !hasAgentError) {
                form.requestSubmit();
            }
        });
    });

    if (agentConfig) {
        applyConfig(agentConfig);
    } else if (providerSelect) {
        updateProviderSections(providerSelect.value);
        syncInteractionState();
    } else {
        syncInteractionState();
    }

    const initialError = errorBanner && !errorBanner.hidden ? errorBanner.textContent : '';
    if (initialError) {
        syncAgentError(initialError);
    } else {
        syncAgentError(null);
    }
})();
</script>
{% endblock %}
