{% extends 'base.html' %}
{% block title %}Settings · Historical Document Reader{% endblock %}

{% block content %}
<div class="container settings-page">
    <h1>User interface &amp; ingestion settings</h1>

    <section id="ui-preferences" class="settings-section">
        <div class="settings-section__header">
            <h2>Interface appearance</h2>
            <p>Customise fonts, sizing, and colour tokens used across the application.</p>
        </div>
        <form method="POST" class="settings-form">
            <input type="hidden" name="action" value="update_ui">
            <div class="settings-grid">
                <div class="settings-group">
                    <h3>Fonts</h3>
                    <label for="fonts_main">Main font</label>
                    <input type="text" id="fonts_main" name="fonts[main]" value="{{ config.get('fonts', {}).get('main', '') }}">
                    <label for="fonts_headers">Header font</label>
                    <input type="text" id="fonts_headers" name="fonts[headers]" value="{{ config.get('fonts', {}).get('headers', '') }}">
                </div>
                <div class="settings-group">
                    <h3>Sizes</h3>
                    <label for="sizes_base">Base size</label>
                    <input type="text" id="sizes_base" name="sizes[base]" value="{{ config.get('sizes', {}).get('base', '') }}">
                    <label for="sizes_h1">Heading 1</label>
                    <input type="text" id="sizes_h1" name="sizes[h1]" value="{{ config.get('sizes', {}).get('h1', '') }}">
                    <label for="sizes_h2">Heading 2</label>
                    <input type="text" id="sizes_h2" name="sizes[h2]" value="{{ config.get('sizes', {}).get('h2', '') }}">
                    <label for="sizes_h3">Heading 3</label>
                    <input type="text" id="sizes_h3" name="sizes[h3]" value="{{ config.get('sizes', {}).get('h3', '') }}">
                </div>
                <div class="settings-group">
                    <h3>Colours</h3>
                    <label for="colors_primary">Primary colour</label>
                    <input type="color" id="colors_primary" name="colors[primary]" value="{{ config.get('colors', {}).get('primary', '#2A4365') }}">
                    <label for="colors_secondary">Secondary colour</label>
                    <input type="color" id="colors_secondary" name="colors[secondary]" value="{{ config.get('colors', {}).get('secondary', '#718096') }}">
                    <label for="colors_background">Background</label>
                    <input type="color" id="colors_background" name="colors[background]" value="{{ config.get('colors', {}).get('background', '#ffffff') }}">
                    <label for="colors_text">Text</label>
                    <input type="color" id="colors_text" name="colors[text]" value="{{ config.get('colors', {}).get('text', '#1a202c') }}">
                </div>
                <div class="settings-group">
                    <h3>Spacing</h3>
                    <label for="spacing_small">Small spacing</label>
                    <input type="text" id="spacing_small" name="spacing[small]" value="{{ config.get('spacing', {}).get('small', '0.5rem') }}">
                    <label for="spacing_medium">Medium spacing</label>
                    <input type="text" id="spacing_medium" name="spacing[medium]" value="{{ config.get('spacing', {}).get('medium', '1rem') }}">
                    <label for="spacing_large">Large spacing</label>
                    <input type="text" id="spacing_large" name="spacing[large]" value="{{ config.get('spacing', {}).get('large', '2rem') }}">
                </div>
            </div>
            <button type="submit">Save UI preferences</button>
        </form>
    </section>

    <section id="data-ingestion" class="settings-section">
        <div class="settings-section__header">
            <h2>Data ingestion</h2>
            <p>Select an archive folder to process images into JSON files. Files are stored in <code>{{ archive_root }}</code>.</p>
        </div>
        <!-- Image ingestion controls allow operators to kick off the backend pipeline
             from the UI.  The markup intentionally mirrors the JavaScript queries in
             settings_data_ingestion.js so element IDs should be kept in sync. -->
        <div class="settings-subsection settings-ingestion__automation" data-ingestion-root>
            <h3>Image ingestion pipeline</h3>
            <p>Generate JSON metadata from image archives using a local Ollama model or the ChatGPT API.</p>
            <form id="imageIngestionForm" class="settings-form"
                  data-options-url="{{ url_for('data_ingestion_options') }}"
                  data-run-url="{{ url_for('settings_run_data_ingestion') }}"
                  data-api-key-url="{{ url_for('settings_save_data_ingestion_key') }}"
                  data-default-provider="{{ ingestion_default_provider }}"
                  data-default-ollama-model="{{ ingestion_default_ollama_model }}"
                  data-default-openai-model="{{ ingestion_default_openai_model }}"
                  data-key-configured="{{ '1' if ingestion_api_key_configured else '0' }}"
                  data-default-ollama-url="{{ ingestion_ollama_base_url or '' }}">
                <div class="settings-grid">
                    <div class="settings-group">
                        <label for="imageIngestionDirectory">Archive folders</label>
                        <div class="settings-directory-picker">
                            <!-- Text input remains for manual entry and automated tests; the button
                                 invokes the native folder picker provided by modern browsers. -->
                            <input type="text" id="imageIngestionDirectory" name="directory" placeholder="e.g. rolls/tray_01">
                            <div class="settings-directory-picker__buttons">
                                <button type="button" class="button button--secondary" data-directory-picker>Choose folder…</button>
                                <button type="button" class="button button--secondary" data-directory-add title="Add the typed folder to the list">Add</button>
                            </div>
                        </div>
                        <!-- Hidden-in-plain-sight file input that powers the native folder picker; kept off-screen via CSS so browsers allow user-initiated clicks. -->
                        <input type="file" id="imageIngestionDirectoryPicker" class="settings-directory-picker__input" webkitdirectory directory multiple>
                        <p class="form-field__hint">Select one or more folders. Relative paths resolve under <code>{{ archive_root }}</code>.</p>
                        <div class="directory-selection" data-directory-selection>
                            <p class="directory-selection__empty" data-directory-empty>No folders selected yet.</p>
                            <ul class="directory-selection__list" data-directory-list></ul>
                        </div>
                    </div>
                    <div class="settings-group">
                        <label for="imageIngestionProvider">Model provider</label>
                        <select id="imageIngestionProvider" name="provider">
                            <option value="ollama" {% if ingestion_default_provider == 'ollama' %}selected{% endif %}>Ollama (local)</option>
                            <option value="openai" {% if ingestion_default_provider == 'openai' %}selected{% endif %}>ChatGPT API</option>
                        </select>
                        <p class="form-field__hint">Choose a local Ollama model or the hosted ChatGPT API.</p>
                    </div>
                </div>
                <div class="settings-grid" data-provider-section="ollama">
                    <div class="settings-group">
                        <label for="imageIngestionOllamaBase">Ollama base URL</label>
                        <input type="text" id="imageIngestionOllamaBase" name="ollama_base_url" value="{{ ingestion_ollama_base_url or '' }}">
                        <p class="form-field__hint">Defaults to {{ ingestion_ollama_base_url or 'http://localhost:11434' }}.</p>
                    </div>
                    <div class="settings-group">
                        <label for="imageIngestionModel">Model</label>
                        <select id="imageIngestionModel" name="model">
                            <option value="{{ ingestion_default_ollama_model }}">{{ ingestion_default_ollama_model }}</option>
                        </select>
                        <button type="button" class="button button--secondary" data-refresh-models>Refresh model list</button>
                        <p class="form-field__hint">Populate from available Ollama models.</p>
                    </div>
                </div>
                <div class="settings-grid" data-provider-section="openai" hidden>
                    <div class="settings-group">
                        <label for="imageIngestionOpenAiModel">ChatGPT model</label>
                        <input type="text" id="imageIngestionOpenAiModel" name="openai_model" value="{{ ingestion_default_openai_model }}">
                        <p class="form-field__hint">Use a multimodal model such as <code>gpt-4o-mini</code>.</p>
                    </div>
                </div>
                <div class="settings-group" data-api-key-row hidden>
                    <label for="imageIngestionApiKey">OpenAI API key</label>
                    <input type="password" id="imageIngestionApiKey" name="api_key" placeholder="{% if ingestion_api_key_configured %}API key configured{% else %}Enter API key{% endif %}">
                    <p class="form-field__hint" data-api-key-hint>{% if ingestion_api_key_configured %}The stored key will be reused if left blank.{% else %}The key is stored outside the container with other environment files.{% endif %}</p>
                </div>
                <div class="settings-group">
                    <label for="imageIngestionPrompt">Processing prompt</label>
                    <textarea id="imageIngestionPrompt" name="prompt" rows="14">{{ ingestion_default_prompt }}</textarea>
                    <p class="form-field__hint">Adjust the instructions used to produce JSON for each document.</p>
                </div>
                <div class="settings-group">
                    <label class="checkbox">
                        <input type="checkbox" id="imageIngestionReprocess" name="reprocess">
                        <span>Reprocess existing JSON files</span>
                    </label>
                    <p class="form-field__hint">When disabled, existing JSON files are skipped if they are already ingested.</p>
                </div>
                <div class="settings-actions">
                    <button type="submit">Process images</button>
                </div>
            </form>
            <div class="ingestion-status" data-ingestion-status hidden></div>
            <dl class="ingestion-summary" data-ingestion-summary hidden></dl>
            <div class="ingestion-errors" data-ingestion-errors hidden></div>
        </div>
        
    </section>

    <section id="chatbot-settings" class="settings-section">
        <div class="settings-section__header">
            <h2>ChatBot configuration</h2>
            <p>Adjust model providers, prompts, and retrieval limits for the Historian Agent. Changes apply immediately for your session.</p>
        </div>
        {% include 'partials/historian_agent_settings.html' with context %}
    </section>
</div>
<script id="historianAgentConfigData" type="application/json">{{ agent_config_payload | tojson }}</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
    const form = document.querySelector('#ui-preferences form');
    if (!form) return;
    form.addEventListener('submit', function(event) {
        ['fonts', 'sizes', 'colors', 'spacing'].forEach(function(key) {
            const inputs = form.querySelectorAll(`[name^="${key}\\["]`);
            const payload = {};
            inputs.forEach(function(input) {
                const match = input.name.match(/\[(.*?)\]/);
                if (!match) return;
                payload[match[1]] = input.value;
            });
            let hidden = form.querySelector(`input[name="${key}"]`);
            if (!hidden) {
                hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = key;
                form.appendChild(hidden);
            }
            hidden.value = JSON.stringify(payload);
        });
    });
})();
</script>
<script src="{{ url_for('static', filename='settings_data_ingestion.js') }}"></script>
<script src="{{ url_for('static', filename='historian_agent.js') }}"></script>
{% endblock %}
