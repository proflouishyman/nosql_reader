<div class="agent-settings" id="agentSettings" data-config-endpoint="{{ config_endpoint }}">
    <div class="agent-settings__header">
        <h3>Historian Agent configuration</h3>
        <p>Tune provider credentials, retrieval parameters, and prompts for the ChatBot experience.</p>
        {% if agent_error %}
        <div class="agent-alert agent-alert--error" role="alert">{{ agent_error }}</div>
        {% endif %}
    </div>
    <form id="agentSettingsForm" class="agent-settings__form" novalidate>
        <div class="form-field form-field--toggle">
            <label for="agentEnabled">
                <span>Enable Historian Agent</span>
                <input type="checkbox" id="agentEnabled" name="enabled" {% if agent_config_payload.enabled %}checked{% endif %} data-help="Enable or disable the Historian Agent without deleting settings.">
            </label>
            <p class="form-field__hint">Disable to pause the ChatBot without removing your settings.</p>
        </div>
        <div class="form-field">
            <label for="agentModelProvider">Model provider</label>
            <select id="agentModelProvider" name="model_provider" data-help="Choose whether responses are generated by Ollama or OpenAI.">
                {% for option in provider_options %}
                <option value="{{ option.value }}" {% if option.value == agent_config_payload.model_provider %}selected{% endif %}>{{ option.label }}</option>
                {% endfor %}
            </select>
            <p class="form-field__hint">Choose between a local Ollama host or a hosted LLM provider.</p>
        </div>
        <div class="agent-provider agent-provider--ollama" data-provider="ollama" {% if agent_config_payload.model_provider != 'ollama' %}hidden{% endif %}>
            <div class="form-field">
                <label for="agentOllamaBaseUrl">Ollama base URL</label>
                <input type="text" id="agentOllamaBaseUrl" name="ollama_base_url" value="{{ agent_config_payload.ollama_base_url }}" placeholder="http://localhost:11434" data-help="Set the HTTP endpoint for your Ollama server.">
                <p class="form-field__hint">Point to the Ollama service inside Docker or on your workstation.</p>
            </div>
        </div>
        <div class="agent-provider agent-provider--openai" data-provider="openai" {% if agent_config_payload.model_provider != 'openai' %}hidden{% endif %}>
            <div class="form-field">
                <label for="agentOpenAiKey">OpenAI API key</label>
                <input type="password" id="agentOpenAiKey" name="openai_api_key" value="" placeholder="{% if agent_config_payload.openai_api_key_present %}API key configured{% else %}Enter OpenAI API key{% endif %}" data-help="Enter a new OpenAI API key or leave blank to keep the existing key.">
                <p class="form-field__hint">Keys are stored in your encrypted Flask session. Leave blank to keep the current key.</p>
            </div>
        </div>
        <div class="form-field">
            <label for="agentModelName">Model name</label>
            <input type="text" id="agentModelName" name="model_name" value="{{ agent_config_payload.model_name }}" placeholder="llama3" data-help="Set the model identifier for the selected provider.">
        </div>
        <div class="form-field form-field--grid">
            <div>
                <label for="agentTemperature">Temperature</label>
                <input type="number" id="agentTemperature" name="temperature" step="0.1" min="0" max="2" value="{{ '%.2f'|format(agent_config_payload.temperature) }}" data-help="Control response variability; lower is more deterministic.">
            </div>
            <div>
                <label for="agentContextDocuments">Context documents</label>
                <input type="number" id="agentContextDocuments" name="max_context_documents" min="1" value="{{ agent_config_payload.max_context_documents }}" data-help="Set how many retrieved documents are passed into each answer.">
            </div>
        </div>
        <div class="form-field">
            <label for="agentSystemPrompt">System prompt</label>
            <textarea id="agentSystemPrompt" name="system_prompt" rows="4" data-help="Edit the base instruction prompt used for every answer.">{{ agent_config_payload.system_prompt }}</textarea>
        </div>
        <div class="form-field">
            <label for="agentContextFields">Context fields</label>
            <textarea id="agentContextFields" name="context_fields" rows="3" data-help="List MongoDB fields (one per line) that retrieval can use as context.">{{ agent_config_payload.context_fields | join('\n') }}</textarea>
            <p class="form-field__hint">Specify MongoDB fields to inspect, one per line.</p>
        </div>
        <div class="form-field">
            <label for="agentSummaryField">Summary fallback field</label>
            <input type="text" id="agentSummaryField" name="summary_field" value="{{ agent_config_payload.summary_field }}" placeholder="content" data-help="Choose the fallback field used when direct snippets are unavailable.">
        </div>
        <div class="form-field form-field--toggle">
            <label for="agentAllowFallback">
                <span>Allow summary fallback</span>
                <input type="checkbox" id="agentAllowFallback" name="allow_general_fallback" {% if agent_config_payload.allow_general_fallback %}checked{% endif %} data-help="Permit fallback answers using the summary field when snippet retrieval fails.">
            </label>
            <p class="form-field__hint">Use the summary field when direct snippets are unavailable.</p>
        </div>
        <div class="form-field form-field--toggle">
            <label for="agentUseVector">
                <span>Enable vector retrieval (RAG)</span>
                <input type="checkbox" id="agentUseVector" name="use_vector_retrieval" {% if agent_config_payload.use_vector_retrieval %}checked{% endif %} data-help="Turn on semantic vector retrieval in addition to keyword matching.">
            </label>
            <p class="form-field__hint">Turn on hybrid keyword + vector search once document chunks have been embedded.</p>
            <!-- Added explicit toggle so users can activate semantic retrieval from the UI. -->
        </div>
        <div class="form-field">
            <label for="agentEmbeddingProvider">Embedding provider</label>
            <select id="agentEmbeddingProvider" name="embedding_provider" data-help="Choose which provider generates embeddings for vector retrieval.">
                <option value="local" {% if agent_config_payload.embedding_provider == 'local' %}selected{% endif %}>Local (HuggingFace)</option>
                <option value="openai" {% if agent_config_payload.embedding_provider == 'openai' %}selected{% endif %}>OpenAI</option>
            </select>
            <p class="form-field__hint">Choose which service should generate chunk embeddings for vector search.</p>
            <!-- Added provider dropdown so the backend can build the correct embedding client. -->
        </div>
        <div class="form-field">
            <label for="agentEmbeddingModel">Embedding model</label>
            <input type="text" id="agentEmbeddingModel" name="embedding_model" value="{{ agent_config_payload.embedding_model }}" placeholder="all-MiniLM-L6-v2" data-help="Set the embedding model name for the selected embedding provider.">
            <p class="form-field__hint">Set the embedding model name supported by your chosen provider.</p>
            <!-- Added model input to keep embedding selection in sync with RAG components. -->
        </div>
        <div class="form-field form-field--grid">
            <div>
                <label for="agentChunkSize">Chunk size</label>
                <input type="number" id="agentChunkSize" name="chunk_size" min="1" value="{{ agent_config_payload.chunk_size }}" data-help="Set the number of characters per indexed text chunk.">
                <p class="form-field__hint">Characters per chunk when building embeddings.</p>
            </div>
            <div>
                <label for="agentChunkOverlap">Chunk overlap</label>
                <input type="number" id="agentChunkOverlap" name="chunk_overlap" min="0" value="{{ agent_config_payload.chunk_overlap }}" data-help="Set how many characters adjacent chunks share.">
                <p class="form-field__hint">Number of characters shared between adjacent chunks.</p>
            </div>
            <!-- Added chunk controls to align retrieval with embedding boundaries. -->
        </div>
        <div class="form-field form-field--grid">
            <div>
                <label for="agentHybridAlpha">Hybrid weighting (alpha)</label>
                <input type="number" id="agentHybridAlpha" name="hybrid_alpha" min="0" max="1" step="0.05" value="{{ '%.2f'|format(agent_config_payload.hybrid_alpha) }}" data-help="Balance keyword vs vector ranking; 0 keyword-only, 1 vector-only.">
                <p class="form-field__hint">0 uses keyword only; 1 uses vector only.</p>
            </div>
            <div>
                <label for="agentVectorStore">Vector store</label>
                <select id="agentVectorStore" name="vector_store_type" data-help="Select the backend store used for embeddings and similarity search.">
                    <option value="chroma" {% if agent_config_payload.vector_store_type == 'chroma' %}selected{% endif %}>Chroma</option>
                </select>
                <p class="form-field__hint">Currently limited to Chroma; storage path configurable below.</p>
            </div>
            <!-- Added hybrid weighting + store selection to mirror backend capabilities. -->
        </div>
        <div class="form-field">
            <label for="agentChromaPath">Chroma persist directory</label>
            <input type="text" id="agentChromaPath" name="chroma_persist_directory" value="{{ agent_config_payload.chroma_persist_directory }}" placeholder="/home/claude/chroma_db" data-help="Set the filesystem path where Chroma data is persisted.">
            <p class="form-field__hint">Override the default vector store path if using a shared volume.</p>
            <!-- Added path override so deployments can target persistent storage. -->
        </div>
        <div class="agent-settings__actions">
            <button type="submit" data-help="Save Historian Agent settings and rebuild the runtime configuration.">Save configuration</button>
            <button type="button" id="agentSettingsReset" class="secondary" data-help="Restore Historian Agent settings to defaults.">Reset to defaults</button>
        </div>
        <div class="agent-config-status" id="agentConfigStatus" role="status" aria-live="polite" hidden></div>
    </form>
</div>
