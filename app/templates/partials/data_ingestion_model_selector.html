<!-- Added ingestion config partial to expose provider and model configuration controls before ingestion actions. -->
<div class="ingestion-config" id="ingestionConfig">
    <h3>Ingestion model settings</h3>
    <p class="form-field__hint">Configure which AI model to use for processing document images.</p>

    <form id="ingestionConfigForm" class="ingestion-config__form">
        <!-- Added provider selector so users can switch between Ollama and OpenAI sources. -->
        <div class="form-field">
            <label for="ingestionProvider">Model provider</label>
            <select id="ingestionProvider" name="provider" class="form-select" data-help="Choose whether ingestion uses a local Ollama model or an OpenAI model.">
                <!-- Added conditional selection so the default provider reflects backend defaults. -->
                <option value="ollama" {% if ingestion_default_provider == 'ollama' %}selected{% endif %}>Ollama (local)</option>
                <option value="openai" {% if ingestion_default_provider == 'openai' %}selected{% endif %}>OpenAI (cloud)</option>
            </select>
            <p class="form-field__hint">Choose between local Ollama or cloud-based OpenAI.</p>
        </div>

        <!-- Added Ollama-specific controls so the UI can gather local runtime settings. -->
        <div class="provider-section" id="ollamaSection">
            <div class="form-field">
                <label for="ollamaBaseUrl">Ollama base URL</label>
                <input
                    type="text"
                    id="ollamaBaseUrl"
                    name="ollama_base_url"
                    value="{{ ingestion_ollama_base_url }}"
                    placeholder="http://localhost:11434"
                    class="form-input"
                    data-help="Set the base URL for the Ollama service used during ingestion.">
                <p class="form-field__hint">URL of your Ollama instance.</p>
            </div>

            <div class="form-field">
                <label for="ollamaModel">Ollama model</label>
                <select id="ollamaModel" name="model" class="form-select" data-help="Select the Ollama model used to process documents.">
                    <option value="">Loading models...</option>
                </select>
                <button
                    type="button"
                    id="refreshModelsBtn"
                    class="button button--small button--secondary"
                    style="margin-top: 8px;"
                    data-help="Refresh the available model list from the Ollama server.">
                    Refresh models
                </button>
                <p class="form-field__hint">Select a vision-capable model for document processing.</p>
            </div>
        </div>

        <!-- Added OpenAI-specific controls so remote processing can be configured. -->
        <div class="provider-section" id="openaiSection" hidden>
            <div class="form-field">
                <label for="openaiModel">OpenAI model</label>
                <select id="openaiModel" name="openai_model" class="form-select" data-help="Select the OpenAI model used for ingestion.">
                    <!-- Added fallback option so unexpected .env defaults still appear in the dropdown. -->
                    {% set preset_models = ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo'] %}
                    {% if ingestion_default_openai_model and ingestion_default_openai_model not in preset_models %}
                        <option value="{{ ingestion_default_openai_model }}" selected>{{ ingestion_default_openai_model }}</option>
                    {% endif %}
                    <option value="gpt-4o" {% if ingestion_default_openai_model == 'gpt-4o' %}selected{% endif %}>GPT-4o</option>
                    <option value="gpt-4o-mini" {% if ingestion_default_openai_model == 'gpt-4o-mini' %}selected{% endif %}>GPT-4o Mini</option>
                    <option value="gpt-4-turbo" {% if ingestion_default_openai_model == 'gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo</option>
                </select>
                <p class="form-field__hint">Select an OpenAI vision model.</p>
            </div>

            <div class="form-field">
                <label for="openaiApiKey">OpenAI API key</label>
                <input
                    type="password"
                    id="openaiApiKey"
                    name="api_key"
                    placeholder="{% if ingestion_api_key_configured %}API key configured{% else %}Enter API key{% endif %}"
                    class="form-input"
                    data-help="Enter an OpenAI API key for ingestion requests, or leave blank to keep the current key.">
                <p class="form-field__hint">Your OpenAI API key will be stored securely.</p>
            </div>
        </div>

        <!-- Added prompt editor so operators can adjust ingestion instructions. -->
        <div class="form-field">
            <label for="ingestionPrompt">Processing prompt</label>
            <textarea
                id="ingestionPrompt"
                name="prompt"
                rows="4"
                class="form-textarea"
                placeholder="{{ ingestion_default_prompt }}"
                data-help="Edit instructions sent to the model while extracting document data.">{{ ingestion_default_prompt }}</textarea>
            <p class="form-field__hint">Instructions for the AI model when processing documents.</p>
        </div>

        <!-- Added status container so frontend script can display validation and load feedback. -->
        <div id="configStatus" class="config-status" hidden></div>
    </form>
</div>

<style>
/* Added scoped styling so the selector visually matches the settings page layout. */
.ingestion-config {
    background: #ffffff;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    border: 1px solid #e2e8f0;
}

.ingestion-config h3 {
    margin-top: 0;
    margin-bottom: 8px;
}

.ingestion-config__form {
    display: grid;
    gap: 20px;
    margin-top: 16px;
}

.form-field {
    display: grid;
    gap: 6px;
}

.form-field label {
    font-weight: 600;
    color: #1e293b;
}

.form-field__hint {
    color: #64748b;
    font-size: 0.875rem;
    margin: 0;
}

.form-select,
.form-input,
.form-textarea {
    padding: 8px 12px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 1rem;
    font-family: inherit;
}

.form-select:focus,
.form-input:focus,
.form-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.button--small {
    padding: 6px 12px;
    font-size: 0.875rem;
}

.provider-section {
    display: grid;
    gap: 16px;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.config-status {
    padding: 12px;
    border-radius: 6px;
    font-size: 0.875rem;
}

.config-status.success {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
}

.config-status.error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
}

.config-status.info {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #bfdbfe;
}
</style>
