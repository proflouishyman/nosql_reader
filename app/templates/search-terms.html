{% extends 'base.html' %}
{% block title %}Unique Terms · Historical Document Reader{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
{% endblock %}

{% block content %}
<div class="container search-terms-page">
    <header>
        <h1>Unique terms explorer</h1>
        <p>Select a field to review the indexed vocabulary of words and phrases extracted from the database.</p>
    </header>

    <div id="searchContainer" class="search-terms__controls">
        <label for="searchInput">Search terms</label>
        <input type="text" id="searchInput" placeholder="Enter search term..." aria-label="Search terms">
        <button id="searchButton" aria-label="Search">Search</button>
    </div>

    <div class="search-terms__filters">
        <label for="fieldSelect">Select field</label>
        <select id="fieldSelect">
            <option value="" disabled selected>Select a field</option>
            {% for field in field_structure|dictsort %}
                {% if field[0] not in unique_fields %}
                <option value="{{ field[0] }}">{{ field[0] }}</option>
                {% endif %}
            {% endfor %}
        </select>
    </div>

    <div class="search-terms__meta">
        <p>Number of unique words: <span id="uniqueWords">0</span></p>
        <p>Number of unique phrases: <span id="uniquePhrases">0</span></p>
        <p>Total number of records: <span id="totalRecords">0</span></p>
    </div>

    <div id="loadingIndicator" class="loading-indicator" hidden>
        <div class="spinner"></div>
        <p>Loading data…</p>
    </div>
    <div id="noDataMessage" class="search-terms__empty" hidden></div>

    <section class="search-terms__panel">
        <h2>Words</h2>
        <table id="wordsTable" class="display" style="width:100%; margin-top: 10px;">
            <thead>
                <tr>
                    <th>Word</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <section class="search-terms__panel">
        <h2>Phrases</h2>
        <table id="phrasesTable" class="display" style="width:100%; margin-top: 10px;">
            <thead>
                <tr>
                    <th>Phrase</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <div class="pagination-controls">
        <button id="prevPage" disabled>Previous</button>
        <span>Page <span id="currentPage">1</span></span>
        <button id="nextPage">Next</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
(function() {
    const wordsTable = $('#wordsTable').DataTable({
        pageLength: 25,
        order: [[0, 'asc']],
        columns: [
            { data: 'word' },
            { data: 'count' }
        ],
        paging: false,
        info: false,
        searching: false
    });

    const phrasesTable = $('#phrasesTable').DataTable({
        pageLength: 25,
        order: [[0, 'asc']],
        columns: [
            { data: 'phrase' },
            { data: 'count' }
        ],
        paging: false,
        info: false,
        searching: false
    });

    let currentPage = 1;
    const perPage = 100;
    let selectedField = '';
    let searchQuery = '';

    const loadingIndicator = document.getElementById('loadingIndicator');
    const noDataMessage = document.getElementById('noDataMessage');

    function toggleLoading(active) {
        if (!loadingIndicator) return;
        loadingIndicator.hidden = !active;
    }

    function showEmptyState(message) {
        if (!noDataMessage) return;
        noDataMessage.textContent = message || '';
        noDataMessage.hidden = !message;
    }

    function updateMeta(data) {
        document.getElementById('uniqueWords').textContent = data.unique_words;
        document.getElementById('uniquePhrases').textContent = data.unique_phrases;
        document.getElementById('totalRecords').textContent = data.total_records;
    }

    function updatePagination(page, hasMore) {
        document.getElementById('currentPage').textContent = page;
        document.getElementById('prevPage').disabled = page === 1;
        document.getElementById('nextPage').disabled = !hasMore;
    }

    function fetchData(page) {
        toggleLoading(true);
        showEmptyState('');
        $.ajax({
            url: '{{ url_for('search_terms') }}',
            method: 'GET',
            data: {
                field: selectedField,
                page: page,
                per_page: perPage,
                query: searchQuery
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).done(function(data) {
            if (data.words.length === 0 && data.phrases.length === 0) {
                showEmptyState('No data available for the selected field or search query.');
            }
            wordsTable.clear();
            data.words.forEach(item => wordsTable.row.add(item));
            wordsTable.draw();

            phrasesTable.clear();
            data.phrases.forEach(item => phrasesTable.row.add(item));
            phrasesTable.draw();

            updateMeta(data);
            const hasMore = data.words.length === perPage || data.phrases.length === perPage;
            updatePagination(page, hasMore);
        }).fail(function(xhr, status, error) {
            alert('Error fetching data: ' + error);
        }).always(function() {
            toggleLoading(false);
        });
    }

    $('#fieldSelect').on('change', function() {
        selectedField = $(this).val();
        currentPage = 1;
        fetchData(currentPage);
    });

    $('#searchButton').on('click', function() {
        searchQuery = $('#searchInput').val().trim();
        currentPage = 1;
        fetchData(currentPage);
    });

    $('#prevPage').on('click', function() {
        if (currentPage > 1) {
            currentPage -= 1;
            fetchData(currentPage);
        }
    });

    $('#nextPage').on('click', function() {
        currentPage += 1;
        fetchData(currentPage);
    });
})();
</script>
{% endblock %}
