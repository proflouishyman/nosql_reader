version: "3.9"

services:
  mongodb:
    image: mongo:6.0
    container_name: nosql_reader_mongodb
    env_file: .env
    environment:
      # Map canonical MONGO_ROOT_* values onto the variables the Mongo image expects.
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    volumes:
      - type: bind
        source: ${MONGO_DATA_HOST_PATH:-../mongo_data}
        target: ${MONGO_DATA_PATH:-/data/db}
    ports:
      - "27017:27017"
    healthcheck:
      test: [
        "CMD",
        "mongosh",
        "--username",
        "${MONGO_INITDB_ROOT_USERNAME}",
        "--password",
        "${MONGO_INITDB_ROOT_PASSWORD}",
        "--authenticationDatabase",
        "admin",
        "--eval",
        "db.adminCommand('ping')"
      ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  app:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: nosql_reader_app
    env_file: .env
    environment:
      FLASK_APP: main.py  # Point Flask CLI to renamed main module
      # Provide the canonical URI so the entrypoint can expose MONGO_URI to the app.
      APP_MONGO_URI: ${APP_MONGO_URI}
      ARCHIVES_PATH: ${ARCHIVES_PATH:-/data/archives}
      SESSION_FILE_DIR: ${SESSION_PATH:-/app/flask_session}
      HISTORIAN_AGENT_ENABLED: ${HISTORIAN_AGENT_ENABLED:-1}
      HISTORIAN_AGENT_MODEL_PROVIDER: ${HISTORIAN_AGENT_MODEL_PROVIDER:-ollama}
      HISTORIAN_AGENT_MODEL: ${HISTORIAN_AGENT_MODEL:-llama3}
      HISTORIAN_AGENT_TEMPERATURE: ${HISTORIAN_AGENT_TEMPERATURE:-0.2}
      HISTORIAN_AGENT_CONTEXT_K: ${HISTORIAN_AGENT_CONTEXT_K:-4}
      HISTORIAN_AGENT_CONTEXT_FIELDS: ${HISTORIAN_AGENT_CONTEXT_FIELDS:-title,content}
      HISTORIAN_AGENT_SUMMARY_FIELD: ${HISTORIAN_AGENT_SUMMARY_FIELD:-content}
      HISTORIAN_AGENT_FALLBACK: ${HISTORIAN_AGENT_FALLBACK:-1}
      # Added vector retrieval feature flags to keep container config in sync.  # change rationale comment
      HISTORIAN_AGENT_USE_VECTOR_RETRIEVAL: ${HISTORIAN_AGENT_USE_VECTOR_RETRIEVAL:-false}
      HISTORIAN_AGENT_EMBEDDING_PROVIDER: ${HISTORIAN_AGENT_EMBEDDING_PROVIDER:-local}
      HISTORIAN_AGENT_EMBEDDING_MODEL: ${HISTORIAN_AGENT_EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      HISTORIAN_AGENT_CHUNK_SIZE: ${HISTORIAN_AGENT_CHUNK_SIZE:-1000}
      HISTORIAN_AGENT_CHUNK_OVERLAP: ${HISTORIAN_AGENT_CHUNK_OVERLAP:-200}
      HISTORIAN_AGENT_VECTOR_STORE: ${HISTORIAN_AGENT_VECTOR_STORE:-chroma}
      CHROMA_PERSIST_DIRECTORY: ${CHROMA_PERSIST_DIRECTORY:-/home/claude/chroma_db}
      HISTORIAN_AGENT_HYBRID_ALPHA: ${HISTORIAN_AGENT_HYBRID_ALPHA:-0.5}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    ports:
      - "5000:5000"
    volumes:
      - type: bind
        source: ${ARCHIVES_HOST_PATH:-../archives}
        target: ${ARCHIVES_PATH:-/data/archives}
      - type: bind
        source: ${SESSION_HOST_PATH:-../flask_session}
        target: ${SESSION_PATH:-/app/flask_session}
      # Added Chroma persistence volume for vector database durability.  # change rationale comment
      - type: bind
        source: ${CHROMA_HOST_PATH:-../chroma_db}
        target: ${CHROMA_PERSIST_DIRECTORY:-/home/claude/chroma_db}
      - type: bind
        source: ./docker-compose.yml
        target: /app/docker-compose.yml
        read_only: true
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - app_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  app_network:
    driver: bridge
