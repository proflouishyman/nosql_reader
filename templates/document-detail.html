{% extends "base.html" %}

{% block content %}
<div class="document-detail">
  <div class="detail-container">
    <div class="info-panel">
      <div class="navigation">
        <a href="{{ url_for('index') }}?return_to_search=true" class="nav-button" title="Return to Search Results">
          <i class="fas fa-search"></i>
        </a>
        <a href="{{ prev_id and url_for('document_detail', doc_id=prev_id) or '#' }}" class="nav-button {{ 'disabled' if not prev_id else '' }}" title="Previous Result">
          <i class="fas fa-chevron-left"></i>
        </a>
        <a href="{{ url_for('index') }}" class="nav-button" title="Home">
          <i class="fas fa-home"></i>
        </a>
        <a href="{{ next_id and url_for('document_detail', doc_id=next_id) or '#' }}" class="nav-button {{ 'disabled' if not next_id else '' }}" title="Next Result">
          <i class="fas fa-chevron-right"></i>
        </a>
      </div>
  
      <h1>{{ document.get('filename', 'Untitled Document') }}</h1>

      <table class="info-table">
        <tbody>
          {% for key, value in document.items() %}
            {% if key != '_id' and key != 'filename' %}
              <tr>
                <th>{{ key|title }}</th>
                <td>
                  {% if value is mapping %}
                    {% for subkey, subvalue in value.items() %}
                      <strong>{{ subkey }}:</strong> {{ subvalue }}<br>
                    {% endfor %}
                  {% elif value is iterable and value is not string %}
                    {% for item in value %}
                      {% if item is mapping %}
                        {% for subkey, subvalue in item.items() %}
                          <strong>{{ subkey }}:</strong> {{ subvalue }}<br>
                        {% endfor %}
                      {% else %}
                        {{ item }}<br>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    {{ value }}
                  {% endif %}
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="image-panel">
      {% if document.get('file_info', {}).get('original_filepath') %}
        <div id="imageContainer">
          <img id="documentImage" src="{{ url_for('serve_image', filename=document['file_info']['original_filepath']) }}" alt="Document Image">
        </div>
        <div class="zoom-controls">
          <button id="zoomIn">Zoom In</button>
          <button id="zoomOut">Zoom Out</button>
          <button id="resetZoom">Reset</button>
        </div>
      {% else %}
        <div class="placeholder-image">
          [Placeholder for Document Image]
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let scale = 1;
  const ZOOM_STEP = 0.1;
  const MAX_SCALE = 3;
  const MIN_SCALE = 0.5;

  const imageContainer = document.getElementById('imageContainer');
  const documentImage = document.getElementById('documentImage');
  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');
  const resetZoomBtn = document.getElementById('resetZoom');

  function setImageTransform() {
    documentImage.style.transform = `scale(${scale})`;
  }

  function zoomIn() {
    if (scale < MAX_SCALE) {
      scale += ZOOM_STEP;
      setImageTransform();
    }
  }

  function zoomOut() {
    if (scale > MIN_SCALE) {
      scale -= ZOOM_STEP;
      setImageTransform();
    }
  }

  function resetZoom() {
    scale = 1;
    setImageTransform();
  }

  zoomInBtn.addEventListener('click', zoomIn);
  zoomOutBtn.addEventListener('click', zoomOut);
  resetZoomBtn.addEventListener('click', resetZoom);

  let isDragging = false;
  let startX, startY, scrollLeft, scrollTop;

  imageContainer.addEventListener('mousedown', (e) => {
    isDragging = true;
    startX = e.pageX - imageContainer.offsetLeft;
    startY = e.pageY - imageContainer.offsetTop;
    scrollLeft = imageContainer.scrollLeft;
    scrollTop = imageContainer.scrollTop;
  });

  imageContainer.addEventListener('mouseleave', () => {
    isDragging = false;
  });

  imageContainer.addEventListener('mouseup', () => {
    isDragging = false;
  });

  imageContainer.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    e.preventDefault();
    const x = e.pageX - imageContainer.offsetLeft;
    const y = e.pageY - imageContainer.offsetTop;
    const walkX = (x - startX) * 2;
    const walkY = (y - startY) * 2;
    imageContainer.scrollLeft = scrollLeft - walkX;
    imageContainer.scrollTop = scrollTop - walkY;
  });
</script>
{% endblock %}
